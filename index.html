<!DOCTYPE html> 

<html> 
	
<head> 
        
<title> fgmk Game
</title> 

		
<style>
body{
    background-color: black;
	padding: 0px;
	margin: 0px;
    overflow:hidden;
}

canvas {
    display: block;
    margin:0 auto 0 auto;
}

#viewport {
    width: 100%;
    height: 100%;


    image-rendering: -moz-crisp-edges;
    image-rendering: -o-crisp-edges;
    image-rendering: -webkit-optimize-contrast;
    -ms-interpolation-mode: nearest-neighbor;
}
</style>
<meta name="theme-color" content="#000000"> 
        
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1, user-scalable=0" /> 
        
<meta name="apple-mobile-web-app-capable" content="yes" /> 
        
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" /> 
        
<link rel="icon" sizes="192x192" href="icon.png"> 
		
<meta charset="UTF-8"/> 

		
<script>
playbutton={setup:function(callback){playbutton.callback=callback;if(window.mobilecheck()){var createButton=function(buttonname,context,func){var button=document.createElement("input");button.type="button";button.value=buttonname;button.id="play_button";button.style["appearance"]="none";button.style["box-shadow"]="none";button.style["border-radius"]=0;button.style["color"]="#bbb";button.style["background-color"]="#111";button.style["border"]="none";button.style["font-size"]="60px";button.style["font-family"]="INFO56";button.style.position="absolute";button.style["z-index"]=1e3;button.style.top="50%";button.style.left="50%";button.style.margin="-100px -200px";button.style.height="200px";button.style.width="400px";button.addEventListener("click",func);button.addEventListener("touchstart",func);context.appendChild(button)};this.gameStart=function(){var button=document.getElementById("play_button");for(var sound in feedbackEng.loadedSounds){feedbackEng.loadedSounds[sound].play()}for(var song in resources.music){resources.music[song].play();resources.music[song].pause()}bgmusic.play(resources.init["World"]["initMusic"]);button.removeEventListener("click",this.gameStart);button.removeEventListener("touchstart",this.gameStart);playbutton.callback();playbutton.callback=0;button.parentNode.removeChild(button);button=0;return false};createButton("PLAY GAME",document.documentElement,this.gameStart)}else{playbutton.callback();bgmusic.play(resources.init["World"]["initMusic"]);playbutton.callback=0}}};
</script>

<script>
isInt=Number.isInteger||function(val){return typeof val==="number"&&isFinite(val)&&Math.floor(val)===val};function clone(existingArray){var newObj=existingArray instanceof Array?[]:{};for(i in existingArray){if(i=="clone")continue;if(existingArray[i]&&typeof existingArray[i]=="object"){newObj[i]=clone(existingArray[i])}else{newObj[i]=existingArray[i]}}return newObj}var addEvent=function(object,type,callback){if(object==null||typeof object=="undefined")return;if(object.addEventListener){object.addEventListener(type,callback,false)}else if(object.attachEvent){object.attachEvent("on"+type,callback)}else{object["on"+type]=callback}};getkey0=function(tree,key){if(key in tree)return tree[key];else return 0};function removeA(arr){var what,a=arguments,L=a.length,ax;while(L>1&&arr.length){what=a[--L];while((ax=arr.indexOf(what))!==-1){arr.splice(ax,1)}}return arr}window.mobilecheck=function(){return window.forceMobile||window.__mobilecheck()};window.__mobilecheck=function(){var check=false;(function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))check=true})(navigator.userAgent||navigator.vendor||window.opera);return check};window.isFirefox=function(){var check=false;(function(a){if(/firefox/i.test(a))check=true})(navigator.userAgent||navigator.vendor||window.opera);return check};
</script>

<script>
var resources={init:{},tileset:null,playerChara:null,printerset:null,playerCharaset:null,faceset:null,feedback:{},items:{},levels:{},charasets:{},charas:{},hms:{}};resources.harvest=function(callback){resources.finalCallback=callback;var DESCRIPTORS="descriptors/";var CHARASETS="charaset/";var LEVELS="levels/";var MUSIC="audio/music/";this.faceset=document.getElementById("faceset");this.charasetimg=document.getElementById("charasetimg");this.printerset=document.getElementById("printerimg");this.monsterimg=document.getElementById("monsterbattleimg");this.tile={};this.pictures={};this.syspictures={};this.music={};this.syspictures.title=document.getElementById("titleimg");this.syspictures.keys1=document.getElementById("keys1");this.syspictures.keys2=document.getElementById("keys2");this.syspictures.controllers=document.getElementById("controllers");this.errors=0;this.tileslist=[];this.loadingList=[];var audioSupport=function(){var audioTest=typeof Audio!=="undefined"?new Audio:null;if(!audioTest||typeof audioTest.canPlayType!=="function"){return{mp3:false,ogg:false,wav:false,aac:false}}var mpegTest=audioTest.canPlayType("audio/mpeg;").replace(/^no$/,"");return{mp3:!!(mpegTest||audioTest.canPlayType("audio/mp3;").replace(/^no$/,"")),ogg:!!audioTest.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!audioTest.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),aac:!!audioTest.canPlayType("audio/aac;").replace(/^no$/,"")}};this.audioSupport=audioSupport();var reportLoadingErrors=function(resDict){document.getElementsByTagName("canvas")[0].getContext("2d").fillStyle="#FF6677";document.getElementsByTagName("canvas")[0].getContext("2d").fillText(resDict.from+" failed!",64,96+32*resources.error);resources.error+=1};var loadInit=function(){var request=new XMLHttpRequest;request.onreadystatechange=function(){if(this.readyState==4&&this.status==200){resources.init=JSON.parse(this.responseText);resources.loadAfterInit()}};request.open("GET",DESCRIPTORS+"init.json",true);request.send()};var scheduleLoad=function(toWhere,fromUrl,fileType,tinyCallback){resources.loadingList.push({to:toWhere,from:fromUrl,fileType:fileType,loaded:false,isScheduled:false,tinyCallback:tinyCallback})};var loadFromSchedule=function(){for(var i=0;i<resources.loadingList.length;i++){resources.doLoad(i)}};var loadAllImages=function(){pic_i=0;tile_i=0;function loadImages(src,callback){if(tile_i<resources.tileslist.length){resources.tile[src]=new Image;resources.tile[src].onload=function(){tile_i++;if(tile_i<resources.tileslist.length){loadImages(resources.tileslist[tile_i],callback)}else if(pic_i<resources.pictureList.length){loadImages(resources.pictureList[pic_i],callback)}else{callback()}};resources.tile[src].src=src}else{var name=src;resources.pictures[name]=new Image;resources.pictures[name].onload=function(){pic_i++;if(pic_i<resources.pictureList.length){loadImages(resources.pictureList[pic_i],callback)}else{callback()}};resources.pictures[name].src="img/pictures/"+name+".png"}}loadImages(resources.tileslist[tile_i],resources.finalCallback)};this.checkAllLoaded=function(){var allLoaded=true;for(var i=0;i<resources.loadingList.length;i++){var resDict=resources.loadingList[i];allLoaded=allLoaded&&resDict.loaded}if(allLoaded){loadAllImages()}};this.doLoad=function(i){var resDict=resources.loadingList[i];if(resDict.isScheduled){return}if(resDict.fileType=="json"){var request=new XMLHttpRequest;request.onreadystatechange=function(){if(this.readyState==4&&this.status==200){if(resDict.to[0]=="charasets"){resources["charasets"]=JSON.parse(this.responseText)["Charaset"]}else if(resDict.to[0]=="feedback"){resources["feedback"]=JSON.parse(this.responseText)["Feedback"]}else if(resDict.to[0]=="charas"){resources["charas"]=JSON.parse(this.responseText)["Charas"]}else if(resDict.to[0]=="items"){resources["items"]=JSON.parse(this.responseText)["Items"]}else{if(resDict.to.length==1){resources[resDict.to[0]]=JSON.parse(this.responseText)}else if(resDict.to.length==2){resources[resDict.to[0]][resDict.to[1]]=JSON.parse(this.responseText)}else if(resDict.to.length==3){resources[resDict.to[0]][resDict.to[1]][resDict.to[2]]=JSON.parse(this.responseText)}}resDict.loaded=true;if(typeof resDict.tinyCallback==="function"){resDict.tinyCallback()}resources.checkAllLoaded()}};request.open("GET",resDict.from,true);request.send();resDict.isScheduled=true}if(resDict.fileType=="ogg"||resDict.fileType=="mp3"||resDict.fileType=="wav"){var internetMediaType={ogg:"audio/ogg",mp3:"audio/mpeg",wav:"audio/wav"};var loadeddata=function(resDict){return function(){if(resDict.loaded)return;resDict.loaded=true;if(typeof resDict.tinyCallback==="function"){resDict.tinyCallback()}resources.checkAllLoaded()}}(resDict);var checkError=function failed(e){if(typeof e.target.error==="undefined"){alert("0 - an obscure error happened - "+e);return}switch(e.target.error.code){case e.target.error.MEDIA_ERR_ABORTED:alert("1 - You aborted the audio playback.");break;case e.target.error.MEDIA_ERR_NETWORK:alert("2 - A network error caused the audio download to fail.");break;case e.target.error.MEDIA_ERR_DECODE:alert("3 - The audio playback was aborted due to a corruption problem or it used features your browser did not support.");break;case e.target.error.MEDIA_ERR_SRC_NOT_SUPPORTED:alert("4 - The audio could not be loaded, either because the server or network failed or because the format is not supported.");break;default:alert("5 - An unknown error occurred.");break}};resources[resDict.to[0]][resDict.to[1]]=document.createElement("audio");resources[resDict.to[0]][resDict.to[1]].id=resDict.to[1];resources[resDict.to[0]][resDict.to[1]].loop=true;resources[resDict.to[0]][resDict.to[1]].addEventListener("error",checkError,true);var request=new XMLHttpRequest;request.onreadystatechange=function(){if(this.readyState==4&&this.status==200){var blob=new Blob([this.response],{type:internetMediaType[resDict.fileType]});var objectUrl=window.URL.createObjectURL(blob);resources[resDict.to[0]][resDict.to[1]].src=objectUrl;resources[resDict.to[0]][resDict.to[1]].onload=function(evt){window.URL.revokeObjectURL(objectUrl)};this.onerror=null;loadeddata()}};request.onerror=function(resDict,request){return function(){reportLoadingErrors(resDict);if(request.retry<request.maxRetries){request.responseType="blob";request.open("GET",resDict.from,true);request.send();request.retry+=1}else{alert("error loading: "+resDict.from)}}}(resDict,request);request.retry=0;request.maxRetries=3;request.responseType="blob";request.open("GET",resDict.from,true);request.send();resDict.isScheduled=true}};this.loadAfterInit=function(){resources.pictureList=resources.init["PictureList"];var LevelsList=resources.init["LevelsList"];for(var level in LevelsList){var levelItem=LevelsList[level];scheduleLoad(["levels",level],DESCRIPTORS+LEVELS+levelItem,"json",function(level){return function(){var tileimage=resources["levels"][level]["Level"]["tileImage"];if(resources.tileslist.indexOf(tileimage)<0){resources.tileslist.push(tileimage)}}}(level))}var CharasetFileList=this.init["CharasetFileList"];for(var charasetfilep in CharasetFileList){var charasetfile=CharasetFileList[charasetfilep];scheduleLoad(["charasets"],DESCRIPTORS+CHARASETS+charasetfile,"json",function(){resources.playerCharaset=resources["charasets"][resources.init["Player"]["charaSet"]]})}scheduleLoad(["charas"],DESCRIPTORS+"charas.json","json");scheduleLoad(["feedback"],DESCRIPTORS+"feedback.json","json");scheduleLoad(["hms"],DESCRIPTORS+resources.init["HMSFile"],"json");scheduleLoad(["items"],DESCRIPTORS+resources.init["itemsFile"],"json");var MusicList=this.init["MusicList"];for(var music in MusicList){var musicFile=MusicList[music];if(this.audioSupport.ogg&&"ogg"in musicFile){scheduleLoad(["music",music],MUSIC+musicFile.ogg,"ogg")}else if(this.audioSupport.mp3&&"mp3"in musicFile){scheduleLoad(["music",music],MUSIC+musicFile.mp3,"ogg")}else if(this.audioSupport.wav&&"wav"in musicFile){scheduleLoad(["music",music],MUSIC+musicFile.wav,"ogg")}}loadFromSchedule()};loadInit()};
</script>

<script>
function rain(__context,__width,__height,___screen){var that=this;var ___context=__context;var rainBufferCanvas=null;var rainBufferCanvasCtx=null;var particles=[];var removeparticles=[];var RainDropTimer=null;var stop=false;var colors=[];var rainBufferWidth=typeof __width==="undefined"?416:__width;var rainBufferHeight=typeof __height==="undefined"?416:__height;this.raining=false;function toColor(num){var g=Math.min(Math.round(num),255);return"rgba("+[g,g,g].join(",")+",1)"}function addRainDrop(){particles[particles.length]=new RainDrop;if(particles.length==that.maxRainDrops)clearInterval(RainDropTimer)}this.startRain=function(){for(var i=0;i<7;i++){colors[i]=toColor(i*128/6+128)}that.raining=true;stop=false;that.maxRainDrops=200;rainBufferCanvas=document.createElement("canvas");rainBufferCanvasCtx=rainBufferCanvas.getContext("2d");rainBufferCanvasCtx.mozImageSmoothingEnabled=false;rainBufferCanvasCtx.canvas.width=rainBufferWidth;rainBufferCanvasCtx.canvas.height=rainBufferHeight;RainDropTimer=setInterval(addRainDrop,200)};this.stopRain=function(){stop=true;clearInterval(RainDropTimer)};function blankRainBC(){var npart=particles.length;rainBufferCanvasCtx.clearRect(0,0,rainBufferCanvasCtx.canvas.width,rainBufferCanvasCtx.canvas.height);if(npart>50){rainBufferCanvasCtx.fillStyle="rgba(0,0,25,0.2)"}else if(npart>35){rainBufferCanvasCtx.fillStyle="rgba(0,0,25,0.15)"}else if(npart>25){rainBufferCanvasCtx.fillStyle="rgba(0,0,25,0.1)"}else if(npart>20){rainBufferCanvasCtx.fillStyle="rgba(0,0,25,0.075)"}else if(npart>15){rainBufferCanvasCtx.fillStyle="rgba(0,0,25,0.05)"}else if(npart>10){rainBufferCanvasCtx.fillStyle="rgba(0,0,25,0.025)"}if(npart>10){rainBufferCanvasCtx.fillRect(0,0,rainBufferCanvasCtx.canvas.width,rainBufferCanvasCtx.canvas.height)}}function DrawRainColor(colori){rainBufferCanvasCtx.beginPath();for(var i=0;i<particles.length;i++){if(colori==particles[i].color){rainBufferCanvasCtx.moveTo(particles[i].x,particles[i].y);rainBufferCanvasCtx.lineTo(particles[i].x+particles[i].width,particles[i].y+particles[i].height)}}rainBufferCanvasCtx.strokeStyle=colors[colori];rainBufferCanvasCtx.stroke()}this.DrawRain=function(){if(that.raining){for(var i=0;i<particles.length;i++){if(particles[i].y<rainBufferHeight){particles[i].y+=particles[i].speed;if(particles[i].y>=rainBufferHeight){particles[i].y=-5;if(stop){removeparticles.push(i)}}particles[i].x+=particles[i].drift;if(particles[i].x>rainBufferWidth){particles[i].x=0;if(stop){removeparticles.push(i)}}}}if(particles.length>0){blankRainBC();for(var k=2;k<6;k++){DrawRainColor(k)}___context.drawImage(rainBufferCanvas,___screen.GSTARTX,___screen.GSTARTY,rainBufferWidth,rainBufferHeight)}if(removeparticles.length>0){removeparticles.sort(function(a,b){return b-a});while(removeparticles.length>0){particles.splice(removeparticles.pop(),1)}if(particles.length==0){that.raining=false}}}};function RainDrop(){var angle=2;this.x=Math.round(Math.random()*rainBufferWidth);this.y=-10;this.drift=Math.round(Math.random()*4)+2;this.speed=this.drift*angle;this.width=8;this.height=8*angle;this.color=this.drift}}
</script>

<script>
items={};items.setup=function(itemsjson){this.inventory={};this.allitems={};this.allitems=itemsjson;this.defaultItem=function(){return{equipable:false,equiped:false,usable:false,reusable:false,unique:false,effect:null,statMod:null,description:false,name:null,icon:null,category:null,action:null,quantity:1}};this.addItem=function(itemname){if(itemname in this.inventory){if(!this.inventory[itemname].unique){this.inventory[itemname].quantity+=1}}else if(itemname in this.allitems){var item=this.defaultItem();for(var key in this.allitems[itemname]){item[key]=this.allitems[itemname][key]}if(item["name"]==null){item["name"]=itemname}this.inventory[itemname]=item}this.menuUpdate(engine.mapMenu)};this.subtractItem=function(itemname){this.inventory[itemname].quantity-=1;if(this.inventory[itemname].quantity<=0){this.deleteItem(itemname)}this.menuUpdate(engine.mapMenu)};this.deleteItem=function(itemname){delete this.inventory[itemname]};this.effect={};this.pts=function(itemname,itemuser){var attributbonus=0;if(typeof itemuser!=="undefined"){var currHero=battle.heroes[itemuser];var attribut=getkey0(this.inventory[itemname].effect);if(attribut=="st"||attribut=="iq"||attribut=="dx"){attributbonus=currHero[attribut]}}var baseplus=getkey0(this.inventory[itemname].effect,"basep");var plus=getkey0(this.inventory[itemname].effect,"plus");return Math.max(battle.diceroll(baseplus+attributbonus)+plus,0)};this.effect.hpup=function(target,pts){target.hp=Math.min(target.hp+pts,target.hpmax)};this.useItem=function(item_name){var itemname=item_name;if(this.inventory[itemname].effect!=null){var points=this.pts(itemname);var target=[];target.push(battle.heroes[player.party[0]]);var effects=this.inventory[itemname].effect.effect;for(var j=0;j<target.length;j++){for(var i=0;i<effects.length;i++){this.effect[effects[i]](target[j],points)}}}if(this.inventory[itemname].action!=null){var position=[Math.floor(player.mapx/32),Math.floor(player.mapy/32)+1];for(var i=0;i<this.inventory[itemname].action.length;i++){var actionAndParam=this.inventory[itemname].action[i];engine.translateActions(actionAndParam[0],actionAndParam[1],position)}}if(this.inventory[itemname].reusable==false){this.subtractItem(itemname)}};this.equipItem=function(itemname){if(player.party.length==1){var currHero=battle.heroes[player.party[0]];var heroname=player.party[0];var eq_item=this.inventory[itemname];if(currHero.equiped[eq_item.category]){}else{eq_item.equiped=heroname;currHero.equiped[eq_item.category]=itemname;if(eq_item.statMod){if(!(typeof eq_item.statMod.st==="undefined")){currHero.mod.st+=eq_item.statMod.st}if(!(typeof eq_item.statMod.dx==="undefined")){currHero.mod.dx+=eq_item.statMod.dx}if(!(typeof eq_item.statMod.iq==="undefined")){currHero.mod.iq+=eq_item.statMod.iq}}}}this.menuUpdate(engine.mapMenu)};this.unequipItem=function(itemname){if(player.party.length==1){var currHero=battle.heroes[player.party[0]];var heroname=player.party[0];var eq_item=this.inventory[itemname];if(currHero.equiped[eq_item.category]==itemname&&eq_item.equiped==heroname){if(eq_item.statMod){if(!(typeof eq_item.statMod.st==="undefined")){currHero.mod.st-=eq_item.statMod.st}if(!(typeof eq_item.statMod.dx==="undefined")){currHero.mod.dx-=eq_item.statMod.dx}if(!(typeof eq_item.statMod.iq==="undefined")){currHero.mod.iq-=eq_item.statMod.iq}}eq_item.equiped=false;currHero.equiped[eq_item.category]=false}else{console.log("tried to unequip item, but it wasn't equiped!")}}this.menuUpdate(engine.mapMenu)};this.lookItem=function(itemname){if(this.inventory[itemname].description){actions.showText(this.inventory[itemname].description)}};this.dropItem=function(itemname){this.subtractItem(itemname)};this.getMenu=function(){return this.menu};this.menuUpdate=function(mapmenu){if(!(typeof this.menu==="undefined")){var wasenable=this.menu.enabled;this.menu.enabled=false;this.menu.mdelete()}else{var wasenable=false;this.menu={}}var items2add={};var i=0;for(var iitem in this.inventory){var item=this.inventory[iitem].name;var k=0;var itemactions={};if(this.inventory[iitem].equipable){if(this.inventory[iitem].equiped){itemactions["unequip"]={};itemactions["unequip"]["index"]=k;itemactions["unequip"]["action"]=[function(the_item){return function(){items.unequipItem(the_item)}}(iitem),"exit"]}else{itemactions["equip"]={};itemactions["equip"]["index"]=k;itemactions["equip"]["action"]=[function(the_item){return function(){items.equipItem(the_item)}}(iitem),"exit"]}k++}if(this.inventory[iitem].usable){itemactions["use"]={};itemactions["use"]["index"]=k;itemactions["use"]["action"]=[function(the_item){return function(){items.useItem(the_item)}}(iitem),"exit"];k++}if(this.inventory[iitem].description){itemactions["look"]={};itemactions["look"]["index"]=k;itemactions["look"]["action"]=[function(the_item){return function(){items.lookItem(the_item)}}(iitem),"exit"];k++}if(!this.inventory[iitem].unique){itemactions["drop"]={};itemactions["drop"]["index"]=k;itemactions["drop"]["action"]=[function(the_item){return function(){items.dropItem(the_item)}}(iitem),"exit"];k++}itemactions["back"]={};itemactions["back"]["action"]="exit";itemactions["back"]["index"]=k++;items2add[item]=new menu(itemactions,i,false,this.inventory[iitem].icon,2,true);i++}if(i==0){items2add["empty"]={};items2add["empty"]["action"]=function(){};items2add["empty"]["index"]=i;i++}items2add["back"]={};items2add["back"]["action"]="exit";items2add["back"]["index"]=i;i++;this.menu=new menu(items2add,0);if(typeof mapmenu==="undefined"){menus.setParent(this.menu)}else{mapmenu.items.items=this.menu;mapmenu.updateOrder();menus.setParent(mapmenu)}menus.setAllDrawables();this.menu.enabled=wasenable}};
</script>

<script>
var menus={allMenus:[],isAnyMenuEnabled:function(){var returnValue=false;for(var _menu in this.allMenus){if(this.allMenus[_menu].enabled){returnValue=true}}return returnValue},updateMenuEnabled:function(){var returnValue=null;for(var _menu in this.allMenus){if(this.allMenus[_menu].enabled){this.allMenus[_menu].update()}}return returnValue},setParent:function(o){if(o.items!=undefined){for(n in o.items){o.items[n].parent=o;this.setParent(o.items[n])}}},setDrawables:function(menuToDraw){var maxOnScreen=menuToDraw.maxOnScreen;var maxItems=menuToDraw.itemsLength;var finalItem=Math.min(maxItems,maxOnScreen);if(menuToDraw.parent==null){menuToDraw["drawx"]=16;menuToDraw["drawy"]=16;menuToDraw["height"]=finalItem*menuToDraw.fontHeight+32;menuToDraw["width"]=menuToDraw.maxItemStringSize()+32}else{if(menuToDraw.stacked){menuToDraw["drawx"]=menuToDraw.parent.drawx+32;menuToDraw["drawy"]=menuToDraw.parent.drawy+32;menuToDraw["height"]=finalItem*menuToDraw.fontHeight+32;menuToDraw["width"]=menuToDraw.maxItemStringSize()+32}else{menuToDraw["drawx"]=menuToDraw.parent.drawx+menuToDraw.parent.width;menuToDraw["drawy"]=menuToDraw.parent.drawy;menuToDraw["height"]=finalItem*menuToDraw.fontHeight+32;menuToDraw["width"]=menuToDraw.maxItemStringSize()+32}}},setAllDrawables:function(){for(var anotherMenu in this.allMenus){for(var aMenu in this.allMenus){this.setDrawables(this.allMenus[aMenu])}}}};function menu(_items,_index,_noexit,_icon,_scale,_stacked){var tempArray=[];_index=typeof _index==="undefined"?null:_index;_noexit=typeof _noexit==="undefined"?false:_noexit;_icon=typeof _icon==="undefined"?null:_icon;_scale=typeof _scale==="undefined"?2:_scale;_stacked=typeof _stacked==="undefined"?false:_stacked;this.items=_items;this.index=_index;this.noexit=_noexit;this.icon=_icon;this.menuScale=_scale;this.stacked=_stacked;this.maxOnScreen=5;this.parent=null;this.enabled=false;this.selectedItem=null;this.wait=false;this.isMenu=true;this.updateOrder=function(){for(var i=0;i<Object.keys(this.items).length;i++){var _itemKey=Object.keys(this.items)[i];tempArray[i]=[_itemKey,this.items[_itemKey].index]}tempArray.sort(function(a,b){return a[1]-b[1]});this.selectedItem=this.items[tempArray[0][0]];for(var i=0;i<tempArray.length;i++){if(i==0){this.items[tempArray[i][0]].previous=tempArray[0][0];this.items[tempArray[i][0]].next=tempArray[i+1][0]}else if(i==tempArray.length-1){this.items[tempArray[i][0]].previous=tempArray[i-1][0];this.items[tempArray[i][0]].next=tempArray[i][0]}else{this.items[tempArray[i][0]].previous=tempArray[i-1][0];this.items[tempArray[i][0]].next=tempArray[i+1][0]}this.items[tempArray[i][0]].itemy=32+i*32;this.items[tempArray[i][0]].selected=false}if(this.selectedItem==null)this.selectedItem=this.items[Object.keys(this.items)[0]];this.selectedItem.selected=true};this.updateOrder();this.fontHeight=png_font.getHeight(this.menuScale);this.maxItemStringSize=function(){var returnValue=0;for(var i=0;i<Object.keys(this.items).length;i++){var _itemKey=Object.keys(this.items)[i];var _itemKeyLength=png_font.getTextWidth(_itemKey,this.menuScale);if(returnValue<_itemKeyLength){returnValue=_itemKeyLength}}return returnValue};this.itemsLength=Object.keys(_items).length;this.exit=function(){this._counter=0;this.enabled=false;HID.inputs["cancel"].active=false;engine.waitTime(200);if(this.parent!=null){this.parent.wait=false;this.parent.menuKeyWasPressed=16}else{engine.atomStack.push(engine.atomStack.push([function(){engine.atomStack=menus.holdAtomStack},""]),"")}};this.activate=function(){this.enabled=true;if(this.parent!=null){this.parent.wait=true}else{menus.holdAtomStack=engine.atomStack;engine.atomStack=new Array}};this._counter=0;this.menuKeyWasPressed=0;this.update=function(){if(this._counter<20)this._counter+=1;if(this.menuKeyWasPressed==0){if(!this.wait){if(HID.inputs["up"].active){this.selectedItem.selected=false;this.selectedItem=this.items[this.selectedItem.previous];this.selectedItem.selected=true;HID.inputs["up"].active=false;this.menuKeyWasPressed=16}else if(HID.inputs["left"].active){}else if(HID.inputs["right"].active){}else if(HID.inputs["down"].active){this.selectedItem.selected=false;this.selectedItem=this.items[this.selectedItem.next];this.selectedItem.selected=true;HID.inputs["down"].active=false;this.menuKeyWasPressed=16}else if(HID.inputs["accept"].active){HID.inputs["accept"].active=false;if(this.selectedItem.action=="exit"){this.exit()}else if(Object.prototype.toString.call(this.selectedItem.action)==="[object Array]"){for(var i=0;i<this.selectedItem.action.length;i++){if(this.selectedItem.action[i]=="exit"){this.exit()}else if(this.selectedItem.action[i]=="goWait"){engine.atomStack.push([function(){this.wait=true},""])}else if(this.selectedItem.action[i]=="stopWait"){engine.atomStack.push([function(){this.wait=false},""])}else{this.selectedItem.action[i]()}}}else{if(typeof this.selectedItem.isMenu==="undefined"){this.selectedItem.action()}else{this.selectedItem.menuKeyWasPressed=16;this.selectedItem.action()}}this.menuKeyWasPressed=16}else if(HID.inputs["cancel"].active){if(this._counter>=20&&this.noexit==false){HID.inputs["cancel"].active=false;this.exit();engine.waitTime(200);this.menuKeyWasPressed=16}}}}else{this.menuKeyWasPressed-=4}};this.action=this.activate;this.mdelete=function(){for(var i=0;i<menus.allMenus.length;i++){if(menus.allMenus[i]==this){menus.allMenus.splice(i,1);break}}};menus.allMenus.push(this)}
</script>

<script>
feedbackEng={};feedbackEng.setup=function(){this.once=false;this.timer=null;this.vibrationOn=false;this.restrictions=false;this.soundOn=true;this.flist={};this.loadedSounds={};this.vibrate=null;this.flist=resources.feedback;navigator.vibrate=navigator.vibrate||navigator.webkitVibrate||navigator.mozVibrate||navigator.msVibrate;if(navigator.vibrate){this.vibrationOn=true}if(window.isFirefox()){this.soundOn=true}for(var sound in this.flist){this.loadedSounds[sound]=document.getElementById(this.flist[sound].s)}function mediaPlaybackRequiresUserGesture(){var video=document.createElement("video");video.play();return video.paused}if(mediaPlaybackRequiresUserGesture()){this.restrictions=true;this.soundOn=false}};feedbackEng.play=function(feedback){if(this.once==false){if(this.vibrationOn){navigator.vibrate(this.flist[feedback].v)}if(this.soundOn){if(this.restrictions){this.loadedSounds[feedback].currentTime=0;this.loadedSounds[feedback].play()}else{this.loadedSounds[feedback].cloneNode(true).play()}}}};feedbackEng.turnOnceOffTime=function(){this.timer=setTimeout(function(){feedbackEng.once=false},100)};
</script>

<script>
var engine={};engine.actions={};var player={};var chars=[];function charalist(){if("charas"in engine.currentLevel["Level"]){listofcharas=engine.currentLevel["Level"]["charas"];if(listofcharas[0]==""){return[]}var count=listofcharas.length;var returnvalue=[];for(var i=0;i<count;i++){var item=listofcharas[i];returnvalue.push(new char(item[0],item[1],item[2]))}return returnvalue}else{return[]}}engine.resetBlocks=function(){actions.blockCounter=0;actions.blockStack=new Array;actions.blockStack.push(actions.blockCounter.valueOf())};engine.setup=function(){engine.toggle=false;engine.currentLevel=null;engine.levels=null;engine.paused=false;engine.mapEventBlocked=false;engine.timer=null;engine.waitKey=false;engine.waitTimeSwitch=false;engine.minimumWait=false;engine.step=4;engine.atomStack=new Array;engine.alertStack=new Array;engine.st={};engine.st.vars={};engine.resetBlocks();engine.state="startScreen";engine.questionBoxUndef=-1;engine.questionBoxAnswer=engine.questionBoxUndef;engine.menuSetup()};engine.menuSetup=function(){items.setup(resources.items);items.menuUpdate();engine.mapMenu=new menu({items:items.menu,status:{action:function(){engine.mapMenu.wait=true;actions.showStatus("hero");engine.atomStack.push([function(){engine.mapMenu.wait=false},null])},index:1},config:new menu({showFPS:new menu({yes:{action:[function(){debug.FPS.show=true},"exit"],index:0},no:{action:[function(){debug.FPS.show=false},"exit"],index:1}},0),stepSpeed:new menu({x2:{action:[function(){engine.step=4},"exit"],index:0},x1:{action:[function(){engine.step=2},"exit"],index:1}},1),sound:new menu({on:{action:[function(){feedbackEng.soundOn=true},"exit"],index:0},off:{action:[function(){feedbackEng.soundOn=false},"exit"],index:1}},2),back:{action:"exit",index:3}},2,false,null,2,true),exit:{action:"exit",index:3}},null,false,null,2);menus.setParent(engine.mapMenu)};engine.playerFaceChar=function(){var count=chars.length;for(var i=0;i<count;i++){var thischar=chars[i];if(player!=thischar){var ppx=Math.floor(player.mapx/32),ppy=Math.floor(player.mapy/32)+1;var cpx=Math.floor(thischar.mapx/32),cpy=Math.floor(thischar.mapy/32)+1;if(ppx-cpx==1&&cpy-ppy==0&&player.facing=="left")return thischar;if(ppx-cpx==-1&&cpy-ppy==0&&player.facing=="right")return thischar;if(ppx-cpx==0&&cpy-ppy==1&&player.facing=="down")return thischar;if(ppx-cpx==0&&cpy-ppy==-1&&player.facing=="up")return thischar}}return false};engine.updateChars=function(){var count=chars.length;for(var i=0;i<count;i++){var thischar=chars[i];thischar.update()}};engine.testWaitForKey=function(){if(HID.inputs["accept"].active){engine.waitKey=false;HID.inputs["accept"].active=false;engine.minimumWait=false}else if(HID.inputs["cancel"].active){engine.waitKey=false;HID.inputs["cancel"].active=false;engine.minimumWait=false}};engine.waitForKey=function(state){engine.waitKey=state;engine.minimumWait=false;setTimeout(function(){engine.minimumWait=true},300)};engine.waitTime=function(time){engine.waitTimeSwitch=true;engine.minimumWait=false;setTimeout(function(){engine.waitTimeSwitch=false},time)};engine.dirKeyActive=function(){if(HID.inputs["up"].active)return"up";else if(HID.inputs["down"].active)return"down";else if(HID.inputs["left"].active)return"left";else if(HID.inputs["right"].active)return"right";else return false};engine.loop=function(){if(!this.paused){if(!engine.waitKey&&!engine.waitTimeSwitch){if(menus.isAnyMenuEnabled()){menus.updateMenuEnabled();engine.runatomStack()}else{if(engine.state=="map"){engine.updateChars()}else if(engine.state=="startScreen"){title.startScreen()}else if(engine.state=="battle"){battle.update()}engine.runatomStack()}engine.alertupdate()}else if(this.minimumWait){this.testWaitForKey()}}HID.clearInputs();if(engine.toggle){HID.processGamepad()}engine.toggle=!engine.toggle;engine.timer=setTimeout("engine.loop()",1e3/60)};engine.runatomStack=function(){if(engine.atomStack.length>0){while(engine.atomStack.length>0){eventToRun=engine.atomStack.shift();if(eventToRun[0]=="block"){break}else{eventToRun[0](eventToRun[1],eventToRun[2])}}}};engine.checkMapBoundaries=function(_char,px,py,mapw,maph){if(_char.facing=="up"){return py>0}else if(_char.facing=="left"){return px>0}else if(_char.facing=="right"){return px<mapw}else if(_char.facing=="down"){return py<maph}return True};engine.facingPosition=function(_char,px,py){var facing=_char.facing;if(facing=="up"){return[py-1,px]}else if(facing=="left"){return[py,px-1]}else if(facing=="right"){return[py,px+1]}else{return[py+1,px]}console.log("error facing! char: "+_char+" ;position: "+px+", "+py);return false};engine.charWalkSteps=function(_char,walkSteps){_char.steps-=walkSteps;if(_char.facing=="up"){_char.mapy-=walkSteps}else if(_char.facing=="left"){_char.mapx-=walkSteps}else if(_char.facing=="right"){_char.mapx+=walkSteps}else if(_char.facing="down"){_char.mapy+=walkSteps}};engine.charaLookToPlayer=function(chara){var ppx=Math.floor(player.mapx/32),ppy=Math.floor(player.mapy/32)+1;var cpx=Math.floor(chara.mapx/32),cpy=Math.floor(chara.mapy/32)+1;var resx=cpx-ppx;var resy=cpy-ppy;if(resx==0&&resy<0){return"down"}else if(resx==0&&resy>0){return"up"}else if(resx<0){return"right"}else{return"left"}console.log("error facing!"+resx+" , "+resy);return false};engine.charaLookAwayPlayer=function(chara){var ppx=Math.floor(player.mapx/32),ppy=Math.floor(player.mapy/32)+1;var cpx=Math.floor(chara.mapx/32),cpy=Math.floor(chara.mapy/32)+1;var resx=cpx-ppx;var resy=cpy-ppy;if(resx==0&&resy<0){return"up"}else if(resx==0&&resy>0){return"down"}else if(resx<0){return"left"}else{return"right"}console.log("error facing!"+resx+" , "+resy);return false};engine.randomDirection=function(){var directions=["down","up","right","left","down"];return directions[Math.floor(Math.random()*4)]};engine.isCharFacingPlayer=function(_char){var ppx=Math.floor(_char.mapx/32),ppy=Math.floor(_char.mapy/32)+1;var cpx=Math.floor(player.mapx/32),cpy=Math.floor(player.mapy/32)+1;if(ppx-cpx==1&&cpy-ppy==0&&_char.facing=="left"){return true}else if(ppx-cpx==-1&&cpy-ppy==0&&_char.facing=="right"){return true}else if(ppx-cpx==0&&cpy-ppy==1&&_char.facing=="down"){return true}else if(ppx-cpx==0&&cpy-ppy==-1&&_char.facing=="up"){return true}return false};engine.evalNum=function(number){var value=number.slice(0);if(isNaN(value)){if(value.indexOf("var:")==0){return engine.st.vars[value.split("var:")[1]]}else if(value.indexOf("ans:")==0){if(value.split("ans:")[1]=="num"){return engine.questionBoxAnswer}else{return engine.questionBoxAnswerStr}}else if(value.indexOf("lastbattle:")==0){return battle.lastresult}else if(value.indexOf("hero:")==0){if(value.split("hero:")[1]=="face"){return player.facing}else if(value.split("hero:")[1]=="x"){return Math.floor(player.mapx/32)}else if(value.split("hero:")[1]=="y"){return Math.floor(player.mapy/32)+1}}else if(value.indexOf("map:")==0){if(value.split("map:")[1]=="this"||value.split("map:")[1]=="current"){return engine.currentLevel.Level.levelName}}else{return value}}else{return+value}};engine.testVar=function(param){var var1=engine.evalNum(param[0]);if(var1=="true"){return true}else if(var1=="false"){return false}var operator=param[1];var var2=engine.evalNum(param[2]);var test={">":function(a,b){return a>b},bigger:function(a,b){return a>b},greater:function(a,b){return a>b},"<":function(a,b){return a<b},smaller:function(a,b){return a<b},less:function(a,b){return a<b},">=":function(a,b){return a>=b},"<=":function(a,b){return a<=b},"==":function(a,b){return a==b},equal:function(a,b){return a==b},"=":function(a,b){return a==b}};return test[operator](var1,var2)};engine.actions.addItem=function(param){for(var i=0;i<param.length;i++){items.addItem(param[i])}};engine.actions.subtractItem=function(param){for(var i=0;i<param.length;i++){items.subtractItem(param[i])}};engine.actions.runScript=function(param){var fpos=player.facingPosition();for(var i=0;i<param.length;i++){engine.translateActions(param[i][0],param[i][1],fpos)}};engine.actions.battle=function(param){var monsterlist=[];var musicBattle=resources.init["World"]["battleMusic"];var musicHuzzah=resources.init["World"]["battleVictoryMusic"];for(var i=0;i<param.length;i++){if(param[i].indexOf("music:")==0){musicBattle=value.split("music:")[1]}else if(param[i].indexOf("musicwin:")==0){musicHuzzah=value.split("musicwin:")[1]}else{monsterlist.push(param[i])}}bgmusic.pushSong();battle.start(monsterlist,musicBattle,musicHuzzah)};engine.actions.changeState=function(param){engine.state=param[0]};engine.actions.playMusic=function(param){bgmusic.play(param[0]);console.log(param[0])};engine.actions.teleportInPlace=function(param){var px=Math.floor(player.mapx/32),py=Math.floor(player.mapy/32)+1;var map=param[0];engine.actions.teleport([px,py,map])};engine.actions.teleport=function(param){engine.state="map";engine.currentLevel=resources["levels"][param[2]];resources.tileset=resources.tile[engine.currentLevel.Level.tileImage];camera.setupMap(engine.currentLevel);player.mapx=parseInt(param[0],10)*32;player.mapy=(parseInt(param[1],10)-1)*32;player.steps=0;HID.cleanInputs();HID.clearInputs();chars=new charalist;chars.push(player);engine.waitTime(100)};engine.actions.changeTile=function(param){if(param[6]==null||param[6]=="this"){var levelToChange=engine.currentLevel}else{var levelToChange=resources["levels"][param[6]]}if(param[2]!=-1){levelToChange["Level"]["colision"][param[4]][param[5]]=param[2]}if(param[3]!=-1){levelToChange["Level"]["events"][param[4]][param[5]]=param[3]}levelToChange["Level"][param[1]][param[4]][param[5]]=param[0]};engine.actions.changeAllTiles=function(param){var originalTile=param[0];var newTile=param[1];var layer=param[2];if(param[5]==null||param[5]=="this"){var levelToChange=engine.currentLevel}else{var levelToChange=resources["levels"][param[5]]}var h=levelToChange["Level"]["colision"].length;var w=levelToChange["Level"]["colision"][0].length;for(var y=0;y<h;y++){for(var x=0;x<w;x++){var currTile=levelToChange["Level"][layer][y][x];if(currTile==originalTile){if(param[3]!=-1){levelToChange["Level"]["colision"][y][x]=param[3]}if(param[4]!=-1){levelToChange["Level"]["events"][y][x]=param[4]}levelToChange["Level"][layer][y][x]=param[1]}}}};engine.actions.IF=function(param,blockId){if(engine.testVar(param)){var removeActions=false;for(var i=0;i<engine.atomStack.length;i++){if(engine.atomStack[i][0]==engine.actions.ELSE&&engine.atomStack[i][2]==blockId){removeActions=true}if(engine.atomStack[i][0]==engine.actions.END&&engine.atomStack[i][2]==blockId){return}if(removeActions){engine.atomStack.splice(i,1);i--}}}else{var actToRun=[0,0,0];while(engine.atomStack.length>0&&actToRun[0]!=engine.actions.END&&actToRun[0]!=engine.actions.ELSE||actToRun[2]!=blockId){actToRun=engine.atomStack.shift()}}};engine.actions.END=function(){};engine.actions.ELSE=function(){};engine.actions.setVar=function(param){engine.st.vars[param[0]]=engine.evalNum(param[1])};engine.actions.varPlusOne=function(param){if(isNaN(engine.st.vars[param[0]])){engine.st.vars[param[0]]=0}engine.st.vars[param[0]]++};engine.actions.showPicture=function(param){var picture={};picture["image"]=param[0];picture["position"]=[param[1],param[2]];if(param[3]=="sys"){picture["sys"]=true}screen.pictureStack.push(picture)};engine.actions.stopPicture=function(param){screen.clearPicture()};engine.actions.charAutoDelete=function(param,charatodel){if(typeof charatodel==="undefined"){return}var k=-2;for(var i=0;i<chars.length;i++){if(chars[i]==charatodel){k=i;break}}if(chars[k]!=engine.player){chars.splice(k,1)}};engine.actions.questionBox=function(param){var answers={};engine.questionBoxAnswer=engine.questionBoxUndef;if(!(typeof engine.questionBoxMenu==="undefined")){engine.questionBoxMenu.mdelete()}for(var i=0;i<param.length;i++){(function(i){answers[param[i]]={action:[function(){engine.questionBoxAnswer=i;engine.questionBoxAnswerStr=param[i]},"exit"],index:i}})(i)}engine.questionBoxMenu=new menu(answers,undefined,true);menus.setParent(engine.questionBoxMenu);menus.setAllDrawables();engine.questionBoxMenu.activate()};engine.actions.proceedBattleTurn=function(param){battle.waitherodecision=false};engine.actions.changePlayerAnimation=function(param){var animation=param[0];if(param[0]=="default"){player.curr_animation=false}else{player.curr_animation=param[0]}};engine.actions.alert=function(param){var textalert=param;var textlife=60;for(var i=0;i<engine.alertStack.length;i++){if(engine.alertStack[i][0]==textalert){engine.alertStack[i][1]+=textlife;return}}engine.alertStack.push([textalert,textlife])};engine.alertupdate=function(){if(engine.alertStack.length>0){for(var i=0;i<engine.alertStack.length;i++){engine.alertStack[i][1]--}engine.alertStack.sort(function(a,b){return a[1]-b[1]});if(engine.alertStack[0][1]<=0){engine.alertStack.pop()}}};engine.translateActions=function(action,param,position,charsender){actions[action](param,position,charsender)};function char(chara,x,y){this["chara"]=resources["charas"][chara];this["nocolision"]=this.chara.properties.nocolision;this["charaset"]=resources["charasets"][this["chara"]["charaset"]];this["pushable"]=this.chara.properties.pushable;this["facing"]="down";this["steps"]=0;this["waits"]=0;this["mapx"]=x*32;this["mapy"]=(y-1)*32;this["movstack"]=clone(this["chara"]["movements"]);this["stopped"]=false;this["curr_animation"]=false;this["mapheight"]=engine.currentLevel["Level"]["colision"].length-1;this["mapwidth"]=engine.currentLevel["Level"]["colision"][0].length;this["checkMapBoundaries"]=function(px,py,mapw,maph){return engine.checkMapBoundaries(this,px,py,mapw,maph)};this["facingPosition"]=function(px,py){return engine.facingPosition(this,px,py)};this["isFacingPlayer"]=function(){return engine.isCharFacingPlayer(this)};this["imediate"]=this.chara.actions.type[1]==1;this["followPlayer"]=function(){this.facing=engine.charaLookToPlayer(this)};this["awayPlayer"]=function(){this.facing=engine.charaLookAwayPlayer(this)};this["update"]=function(){if(printer.isShown)return;if(this.steps==0&&this.waits==0&&this.stopped==false){if(this["movstack"].length>0){var px=Math.floor(this.mapx/32),py=Math.floor(this.mapy/32)+1;var moveToDo=this["movstack"].shift();if(moveToDo[0]=="move"){if(moveToDo[1]=="follow"){this.followPlayer()}else if(moveToDo[1]=="away"){this.awayPlayer()}else if(moveToDo[1]=="random"){this.facing=engine.randomDirection()}else{this.facing=moveToDo[1]}var fpos=this.facingPosition(px,py);if(this.imediate){if(this.isFacingPlayer()){var playerpx=Math.floor(player.mapx/32),playerpy=Math.floor(player.mapy/32)+1;eventInChar(this,[0,1],[playerpy-1,playerpx])}}if(this.checkMapBoundaries(px,py,this.mapwidth,this.mapheight)&&engine.currentLevel["Level"]["colision"][fpos[0]][fpos[1]]==0){this.steps=32}else{this.waits=16}}if(moveToDo[0]=="face"){if(moveToDo[1]=="follow"){this.followPlayer()}else if(moveToDo[1]=="away"){this.awayPlayer()}else if(moveToDo[1]=="random"){this.facing=engine.randomDirection()}else{this.facing=moveToDo[1]}this.waits=16}}else{if(this["chara"]["movements"]!=[]){this["movstack"]=clone(this["chara"]["movements"])}}}else if(this.steps>0&&this.waits==0&&this.stopped==false){engine.charWalkSteps(this,engine.step)}else if(this.waits>0&&this.stopped==false){this.waits-=2}}}player.setup=function(){player["charaset"]=resources.playerCharaset;player["facing"]=resources.init["Player"]["facing"];player["party"]=resources.init["Player"]["party"];player["steps"]=0;player["waits"]=0;player["running"]=false;player["curr_animation"]=false;player["checkMapBoundaries"]=function(px,py,mapw,maph){return engine.checkMapBoundaries(player,px,py,mapw,maph)};player["update"]=function(){if(printer.isShown)return;var px=Math.floor(player.mapx/32),py=Math.floor(player.mapy/32)+1;var mapheight=engine.currentLevel["Level"]["colision"].length-1;var mapwidth=engine.currentLevel["Level"]["colision"][0].length;if(player.steps==0&&player.waits==0){var dirkey=engine.dirKeyActive();if(dirkey){engine.mapEventBlocked=false;player.mapx=px*32,player.mapy=(py-1)*32;player.facing=dirkey;var fpos=player.facingPosition();if(player.checkMapBoundaries(px,py,mapwidth,mapheight)){var charFacing=engine.playerFaceChar();if(charFacing.pushable){charFacing.movstack.push(["move","away"])}if(engine.currentLevel["Level"]["colision"][fpos[0]][fpos[1]]==0&&!charFacing.nocolision){player.steps=32;if(charFacing){eventInChar(charFacing,[0,1],[py-1,px])}}else{feedbackEng.play("stop");HID.inputs[dirkey].active=false}}else{feedbackEng.play("stop");HID.inputs[dirkey].active=false}}else if(HID.inputs["accept"].active){var charFacing=engine.playerFaceChar();if(charFacing){if(eventInChar(charFacing,[1,0],[py-1,px])){HID.inputs["accept"].active=false;engine.waitTime(300)}else{player.waits=16}}else{if(py-1>0&&px-1>0&&px+1<engine.currentLevel["Level"]["events"].length&&px+1<engine.currentLevel["Level"]["events"].length){var fpos=player.facingPosition();if(eventInMap(engine.currentLevel["Level"],[1,0],fpos)){HID.inputs["accept"].active=false;engine.waitTime(300)}}}}else if(HID.inputs["cancel"].active){HID.inputs["cancel"].active=false;engine.mapMenu.activate()}}else if(player.waits==0){engine.charWalkSteps(player,engine.step);if(player.running){if(!(player.steps==0)){engine.charWalkSteps(player,engine.step)}}if(player.mapx%32==0&&player.mapy%32==0){var px=Math.floor(player.mapx/32),py=Math.floor(player.mapy/32)+1;if(eventInMap(engine.currentLevel["Level"],[0,1],[py,px])){HID.inputs["accept"].active=false;engine.mapEventBlocked=true}}}else{player.waits-=1}}};player.charaFacingTo=function(chara){var ppx=Math.floor(player.mapx/32),ppy=Math.floor(player.mapy/32)+1;var cpx=Math.floor(chara.mapx/32),cpy=Math.floor(chara.mapy/32)+1;var resx=cpx-ppx;var resy=cpy-ppy;if(resx==0&&resy<0)return"down";else if(resx==0&&resy>0)return"up";else if(resx<0&&resy==0)return"right";else return"left";console.log("error facing!");return false};player.facingPosition=function(){var px=Math.floor(player.mapx/32),py=Math.floor(player.mapy/32)+1;return engine.facingPosition(player,px,py)};eventInMap=function(level,evType,position){if(engine.mapEventBlocked){return false}var event=level["events"][position[0]][position[1]];if(event==0){return false}engine.resetBlocks();if(level["eventsType"][event.toString()][0]==evType[0]&&level["eventsType"][event.toString()][1]==evType[1]){var aNmb,action,actionAndParam;for(aNmb=0;aNmb<level["eventsActions"][event.toString()].length;aNmb++){actionAndParam=level["eventsActions"][event.toString()][aNmb];engine.translateActions(actionAndParam[0],actionAndParam[1],position)}return true}};eventInChar=function(char,evType,position){if(char["chara"]["actions"]["type"][0]==evType[0]&&char["chara"]["actions"]["type"][1]==evType[1]){char.charwasfacingfirst=char.facing;char.waits=16;var newfacing=player.charaFacingTo(char);if(newfacing){char.facing=newfacing}char.stopped=true;engine.resetBlocks();var aNmb,action,actionAndParam;for(aNmb=0;aNmb<char["chara"]["actions"]["list"].length;aNmb++){actionAndParam=char["chara"]["actions"]["list"][aNmb];engine.translateActions(actionAndParam[0],actionAndParam[1],position,char)}engine.atomStack.push([function(){char.stopped=false;char.facing=char.charwasfacingfirst},""]);return true}else{return false}};
</script>

<script>
var actions={};actions.helpers={};actions.helpers.lastBlock=function(){var value=0;var bstk=actions.blockStack.slice(0);if(bstk.length>1){value=bstk[bstk.length-1]}else if(bstk.length==1){value=bstk[0]}return value};actions.helpers.preText=function(text){var pretexted=text.slice(0);return text.slice(0).replace(/(var:)([a-zA-Z0-9]+)/g,function(varname){return engine.evalNum(varname)})};actions.changePlayerAnimation=function(param,position){var params=param.split(";");engine.atomStack.push([engine.actions.changePlayerAnimation,params])};actions.charAutoDelete=function(param,position,charatodel){var params=param.split(";");engine.atomStack.push([engine.actions.charAutoDelete,params,charatodel])};actions.questionBox=function(param,position){var params=param.split(";");engine.questionBoxAnswer=engine.questionBoxUndef;engine.atomStack.push([engine.actions.questionBox,params]);engine.atomStack.push(["block",null]);engine.atomStack.push(["block",null])};actions.stopPicture=function(param,position){engine.atomStack.push([engine.actions.stopPicture,""])};actions.showPicture=function(param,position){var params=param.split(";");engine.atomStack.push([engine.actions.showPicture,params])};actions.changeState=function(param,position){var params=param.split(";");engine.atomStack.push([engine.actions.changeState,params])};actions.IF=function(param,position){var params=param.split(";");actions.blockCounter++;actions.blockStack.push(actions.blockCounter.valueOf());engine.atomStack.push([engine.actions.IF,params,actions.helpers.lastBlock()])};actions.ELSE=function(param,position){engine.atomStack.push([engine.actions.ELSE,"",actions.helpers.lastBlock()])};actions.END=function(param,position){engine.atomStack.push([engine.actions.END,"",actions.helpers.lastBlock()]);var popped=actions.blockStack.pop()};actions.showStatus=function(param,position){var params=param.split(";");var herotoshow=battle.heroes[params[0]];engine.atomStack.push([function(herotosh){battle.herotoshowstatus=herotosh},herotoshow]);engine.atomStack.push([engine.waitForKey,true]);engine.atomStack.push(["block",null]);engine.atomStack.push([function(){battle.herotoshowstatus=false;engine.waitTime(400)},""])};actions.showText=function(param,position){var params=param.split(";");var text=actions.helpers.preText(params[0]);engine.atomStack.push([printer.showText,text])};actions.playMusic=function(param){var params=param.split(";");engine.atomStack.push([engine.actions.playMusic,params])};actions.teleport=function(param,position){var params=param.split(";");engine.atomStack.push([function(){screen.paused=true},""]);engine.atomStack.push([engine.actions.teleport,params]);engine.atomStack.push([function(){screen.paused=false},""])};actions.teleportInPlace=function(param,position){var params=param.split(";");engine.atomStack.push([function(){screen.paused=true},""]);engine.atomStack.push([engine.actions.teleportInPlace,params]);engine.atomStack.push([function(){screen.paused=false},""])};actions.changeTile=function(param,position){var colisionDict={keep:-1,noColision:0,collidable:1};var params3Value;var params=param.split(";");var aTileType=params[0];var aLayer=params[1];var aColision=colisionDict[params[2]];if(params[3]=="keep"){params3Value=-1}else if(params[3]=="remove"){params3Value=0}else{params3Value=parseInt(params[3],10)}var aEvent=params3Value;var aPositionX;var aPositionY;var aLevel;if(params[4]=="current"){aPositionY=parseInt(position[0],10);aPositionX=position[1];aLevel=null}else{aPositionX=params[4];aPositionY=params[5];aLevel=params[6]}engine.atomStack.push([engine.actions.changeTile,[aTileType,aLayer,aColision,aEvent,aPositionY,aPositionX,aLevel]])};actions.changeAllTiles=function(param,position){var colisionDict={keep:-1,noColision:0,collidable:1};var params3Value;var params=param.split(";");var originalTileType=params[0];var newTileType=params[1];var aLayer=params[2];var aColision=colisionDict[params[3]];if(params[4]=="keep"){params3Value=-1}else if(params[4]=="remove"){params3Value=0}else{params3Value=parseInt(params[4],10)}var aEvent=params3Value;var aLevel=params[5];engine.atomStack.push([engine.actions.changeAllTiles,[originalTileType,newTileType,aLayer,aColision,aEvent,aLevel]])};actions.fadeIn=function(param,position){var params=param.split(";");engine.atomStack.push([screen.effects.fadeIn,params]);for(var i=0;i<8;i++){engine.atomStack.push(["block",null])}};actions.fadeOut=function(param,position){var params=param.split(";");engine.atomStack.push([screen.effects.fadeOut,params]);for(var i=0;i<8;i++){engine.atomStack.push(["block",null])}};actions.setVar=function(param,position){var params=param.split(";");engine.atomStack.push([engine.actions.setVar,params])};actions.varPlusOne=function(param,position){var params=param.split(";");engine.atomStack.push([engine.actions.varPlusOne,params])};actions.noEffect=function(param,position){engine.atomStack.push([screen.effects.noEffect,""])};actions.battle=function(param,position){var params=param.split(";");actions.fadeOut("tension1;keepEffect");dist.setup(screen.canvas,"bgimg1",1);actions.changeState("battle");engine.atomStack.push([engine.actions.battle,params])};actions.addItem=function(param,position){var params=param.split(";");engine.atomStack.push([engine.actions.addItem,params])};actions.dropItem=function(param,position){var params=param.split(";");engine.atomStack.push([engine.actions.subtractItem,params])};actions.proceedBattleTurn=function(param,position){battle.herodecision="";engine.questionBoxAnswer=engine.questionBoxUndef;engine.atomStack.push([engine.actions.proceedBattleTurn,[""]])};actions.alert=function(param,position){var params=param.split(";");var text=actions.helpers.preText(params[0]);engine.atomStack.push([engine.actions.alert,text])};actions.waitCycle=function(param,position){var params=param.split(";");var cycles=parseInt(params[0]);for(var i=0;i<cycles;i++){engine.atomStack.push(["block",null])}};actions.rain=function(param,position){var params=param.split(";");if(params[0]=="start"){engine.atomStack.push([function(){screen.rains.startRain()},[""]])}else{engine.atomStack.push([function(){screen.rains.stopRain()},[""]])}};
</script>

<script>
textBuffer={buffer:[],drawText:function(text,posx,posy,size){for(var i=0;i<this.buffer.length;i++){if(this.buffer[i]["posx"]==posx&&this.buffer[i]["size"]==size&&this.buffer[i]["posy"]==posy){if(this.buffer[i]["text"]==text){screen.ctx.drawImage(this.buffer[i]["canvas"],screen.GSTARTX+posx,screen.GSTARTY-28+posy);return}}}if(this.buffer.length>24){this.buffer.shift()}var newcanvas=document.createElement("canvas");newcanvas.width=screen.GWIDTH-posx;newcanvas.height=screen.GHEIGHT;png_font.ctx=newcanvas.getContext("2d");png_font.drawText(text,[0,0],"#FFFFFF",size,"#221100");var img=new Image;img.src=newcanvas.toDataURL("image/png");this.buffer.push({text:text,posx:posx,posy:posy,size:size,canvas:img});newcanvas=0}};
</script>

<script>
var camera={};camera.x=0;camera.y=0;camera.finex=0;camera.finey=0;camera.setupMap=function(_worldLevel,_engine){this.maxWorldWidth=_worldLevel["Level"]["layer1"][0].length;this.maxWorldHeight=_worldLevel["Level"]["layer1"].length};camera.setupCanvas=function(){this.yerror=1-screen.GHEIGHT/32%2;this.xerror=1-screen.GWIDTH/32%2;this.width=Math.floor(screen.GWIDTH/32)+1;this.height=Math.floor(screen.GHEIGHT/32)+1;this.halfWidth=Math.floor(this.width/2);this.halfHeight=Math.floor(this.height/2)};camera.panToChara=function(chara){charatilex=Math.floor(chara.mapx/32);charatiley=Math.floor(chara.mapy/32)+1;if(charatilex>this.halfWidth&&charatilex<this.maxWorldWidth-this.halfWidth){this.x=charatilex;this.finex=chara.mapx%32}else{if(charatilex==this.halfWidth){this.x=this.halfWidth;this.finex=chara.mapx%32}else if(charatilex<this.halfWidth){this.x=this.halfWidth;this.finex=0}else if(charatilex==this.maxWorldWidth-this.halfWidth-this.xerror){this.x=this.maxWorldWidth-this.halfWidth-this.xerror;this.finex=chara.mapx%32}else{this.x=this.maxWorldWidth-this.halfWidth-this.xerror;this.finex=30}}if(charatiley>this.halfHeight&&charatiley<this.maxWorldHeight-this.halfHeight){this.y=charatiley;this.finey=chara.mapy%32}else{if(charatiley==this.halfHeight){this.y=this.halfHeight;this.finey=chara.mapy%32}else if(charatiley<this.halfHeight){this.y=this.halfHeight;this.finey=0}else if(charatiley==this.maxWorldHeight-this.halfHeight-this.yerror){this.y=this.maxWorldHeight-this.halfHeight-this.yerror;this.finey=chara.mapy%32}else{this.y=this.maxWorldHeight-this.halfHeight-this.yerror;this.finey=30}}this.x-=this.halfWidth;this.y-=this.halfHeight};camera.drawMapLayer=function(_worldLevel,_zIndex){var targetFrame=Math.floor(screen.frameCount/8)%4;var vx=0,vy=0,currentTile,tileNumber;var screenx=0,screeny=0;this.panToChara(player);initX=Math.max(0,this.x);initY=Math.max(0,this.y);EndX=Math.min(this.maxWorldWidth,this.x+this.width);EndY=Math.min(this.maxWorldHeight,this.y+this.height);for(vx=initX,screenx=0;vx<EndX;vx++,screenx++){for(vy=initY,screeny=0;vy<EndY;vy++,screeny++){tileNumber=_worldLevel.Level[_zIndex][vy][vx];currentTile=_worldLevel.Level.tiles[tileNumber];if(_worldLevel.Level.tilesAnimated[tileNumber]){currentTile=_worldLevel.Level.tilesAnimated[tileNumber][targetFrame]}if(!currentTile||tileNumber==0)continue;screen.drawTile(resources.tileset,currentTile,[32*screenx-this.finex,32*screeny-this.finey])}}};camera.drawChar=function(chara){var charaAnimation=null;if(chara.curr_animation){charaAnimation=chara.charaset[chara.curr_animation][chara.facing]}else if(chara.steps){charaAnimation=chara.charaset.walking[chara.facing]}else{charaAnimation=chara.charaset.standing[chara.facing]}var targetFrame=Math.floor(screen.frameCount/4)%charaAnimation.length;var screenx=0,screeny=0;screenx=chara.mapx-(this.x*32+this.finex);screeny=chara.mapy-(this.y*32+this.finey);screen.drawChara(resources.charasetimg,charaAnimation,targetFrame,[screenx,screeny])};
</script>

<script>
printBox={};printBox.show=function(){screen.printBox.targetFrame=0;screen.printBox.anim="fadeIn"};printBox.isShown=function(){if(screen.printBox.anim=="box"){return true}else{return false}};printBox.close=function(){screen.printBox.targetFrame=screen.printBox.frameMax;screen.printBox.anim="fadeOut"};var screen={};screen.paused=false;screen.WIDTH=416;screen.HEIGHT=704;screen.GWIDTH=screen.WIDTH;screen.GHEIGHT=screen.WIDTH;screen.GSTARTX=0;screen.GSTARTY=0;screen.RATIO=null;screen.currentWidth=null;screen.currentHeight=null;screen.canvas=null;screen.ctx=null;screen.frameCount=0;screen.timer=null;screen.engine=null;screen.mobile=false;screen.setEngine=function(engine){this.engine=engine};screen.drawChara=function(charaset,animation,frameNumber,position){if(position[0]<this.GSTARTX-32||position[0]>this.GWIDTH+32||position[1]<this.GSTARTY-64||position[1]>this.GHEIGHT+64){return}screen.ctx.drawImage(charaset,32*animation[frameNumber][0],64*animation[frameNumber][1],32,64,this.GSTARTX+position[0],this.GSTARTY+position[1],32,64)};screen.drawText=function(text,posx,posy,size){size=typeof size==="undefined"?2:size;textBuffer.drawText(text,posx,posy,size)};screen.drawTile=function(tileset,tile,position){screen.ctx.drawImage(tileset,32*tile[0],32*tile[1],32,32,this.GSTARTX+position[0],this.GSTARTY+position[1],32,32)};screen.drawImage=function(image,position){screen.ctx.drawImage(image,this.GSTARTX+position[0],this.GSTARTY+position[1])};screen.drawFace=function(faceset,tile,position,multiplix){multiplix=typeof multiplix==="undefined"?2:multiplix;screen.ctx.drawImage(faceset,64*tile[0],64*tile[1],64,64,this.GSTARTX+position[0],this.GSTARTY+position[1],64*multiplix,64*multiplix)};screen.flashMonster=function(monster,color){monster.flashcolor=color;monster.flash=10};screen.shakeMonster=function(monster){monster.shake=10};screen.drawMonster=function(monster,position){var tempalpha=screen.ctx.globalAlpha;var modx=0;var mody=0;if(monster.dead){return}if(monster.selected&&monster.flash==0){screen.flashMonster(monster,"#111111")}if(monster.shake>0){monster.shake--;modx=Math.floor(8*Math.random())*4;mody=Math.floor(8*Math.random())*4}if(monster.flash>0){screen.ctx.drawImage(screen.flashColor(resources.monsterimg,monster.flashcolor),64*monster.monsterImg[0],64*monster.monsterImg[1],64,64,this.GSTARTX+position[0]+modx,this.GSTARTY+position[1]+mody,128,128);screen.ctx.globalAlpha=1*monster.flash/10;monster.flash--}screen.ctx.drawImage(resources.monsterimg,64*monster.monsterImg[0],64*monster.monsterImg[1],64,64,this.GSTARTX+position[0]+modx,this.GSTARTY+position[1]+mody,128,128);screen.ctx.globalAlpha=tempalpha;screen.ctx.fillStyle="#ffffff";screen.drawText("hp:"+monster.hp,position[0],position[1]-32);screen.drawText(" /"+monster.hpmax,position[0],position[1]-8)};screen.flashColor=function(fg,color){var buffer=document.createElement("canvas");buffer.width=fg.width;buffer.height=fg.height;var bx=buffer.getContext("2d");bx.fillStyle=color;bx.fillRect(0,0,buffer.width,buffer.height);bx.globalCompositeOperation="destination-atop";bx.drawImage(fg,0,0);return buffer};screen.init=function(){window.addEventListener("resize",screen.resize,false);window.addEventListener("orientationchange",screen.resize,false);this.RATIO=this.WIDTH/this.HEIGHT;this.mobile=window.mobilecheck();this.currentWidth=this.WIDTH;this.currentHeight=this.HEIGHT;this.canvas=document.getElementsByTagName("canvas")[0];this.canvas.width=this.WIDTH;this.canvas.height=this.HEIGHT;this.ctx=this.canvas.getContext("2d");this.ctx.font="32px INFO56";this.ORIGINALGSTARTX=this.GSTARTX;this.ORIGINALGSTARTY=this.GSTARTY;this.resize();screen.HIDcsetup();this.pictureStack=new Array;this.ua=navigator.userAgent.toLowerCase();this.android=this.ua.indexOf("android")>-1?true:false;this.ios=this.ua.indexOf("iphone")>-1||this.ua.indexOf("ipad")>-1?true:false;window.addEventListener("load",screen.init,false);this.ctx.mozImageSmoothingEnabled=false;this.ctx.webkitImageSmoothingEnabled=false;this.ctx.imageSmoothingEnabled=false;addEvent(window,"resize",function(){screen.resize()});(function(){var lastTime=0;var vendors=["ms","moz","webkit","o"];for(var x=0;x<vendors.length&&!window.requestAnimationFrame;++x){window.requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]||window[vendors[x]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame)window.requestAnimationFrame=function(callback,element){var currTime=(new Date).getTime();var timeToCall=Math.max(0,16-(currTime-lastTime));var id=window.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);lastTime=currTime+timeToCall;return id};if(!window.cancelAnimationFrame)window.cancelAnimationFrame=function(id){clearTimeout(id)}})();screen.rains=new rain(this.ctx,this.GWIDTH,this.GHEIGHT,screen);screen.requestAnimationFrame=window.requestAnimationFrame};screen.resize=function(){screen.ctx.mozImageSmoothingEnabled=false;screen.ctx.webkitImageSmoothingEnabled=false;screen.ctx.imageSmoothingEnabled=false;if(screen.mobile){this.currentHeight=window.innerHeight;this.currentWidth=this.currentHeight*this.RATIO;if(window.innerWidth<this.currentWidth){this.currentWidth=window.innerWidth;this.currentHeight=this.currentWidth/this.RATIO}}else{if(window.innerHeight>.8*window.innerWidth){this.GHEIGHT=416;this.currentWidth=window.innerWidth*this.WIDTH/this.GWIDTH;this.currentHeight=this.currentWidth/this.RATIO}else if(window.innerHeight>.6*window.innerWidth){this.GHEIGHT=352;this.currentHeight=window.innerHeight*this.HEIGHT/this.GHEIGHT;this.currentWidth=this.currentHeight*this.RATIO}else{this.GHEIGHT=256;this.currentHeight=window.innerHeight*this.HEIGHT/this.GHEIGHT;this.currentWidth=this.currentHeight*this.RATIO}}screen.printBox.setSize();camera.setupCanvas();if(this.android||this.ios){document.body.style.height=window.innerHeight+50+"px"}screen.canvas.style.width=this.currentWidth+"px";screen.canvas.style.height=this.currentHeight+"px";window.setTimeout(function(){window.scrollTo(0,1)},1)};screen.drawButton=function(pHIDItem){if(!screen.mobile){return}if(pHIDItem.active){this.ctx.fillStyle="#ff9900";this.ctx.fillRect(pHIDItem.mapX,pHIDItem.mapY+this.GHEIGHT,96,96)}};screen.drawHID=function(){if(screen.mobile){this.ctx.drawImage(screen.HIDButtons,0,screen.GHEIGHT);var HIDItem;for(var tag in HID.inputs){HIDItem=HID.inputs[tag];screen.drawButton(HIDItem)}}else{this.ctx.fillStyle="#000000";this.ctx.fillRect(0,screen.GHEIGHT,screen.GWIDTH,screen.HEIGHT-screen.GHEIGHT)}};screen.HIDcsetup=function(){function blendColors(c0,c1,p){var f=parseInt(c0.slice(1),16),t=parseInt(c1.slice(1),16),R1=f>>16,G1=f>>8&255,B1=f&255,R2=t>>16,G2=t>>8&255,B2=t&255;return"#"+(16777216+(Math.round((R2-R1)*p)+R1)*65536+(Math.round((G2-G1)*p)+G1)*256+(Math.round((B2-B1)*p)+B1)).toString(16).slice(1)}screen.HIDButtons=document.createElement("canvas");screen.HIDButtons.width=screen.WIDTH;screen.HIDButtons.height=screen.HEIGHT-screen.GHEIGHT;var hx=screen.HIDButtons.getContext("2d");hx.fillStyle="#221F1B";hx.fillRect(0,0,screen.HIDButtons.width,screen.HIDButtons.height);var HIDItem;for(var tag in HID.inputs){HIDItem=HID.inputs[tag];hx.fillStyle=HIDItem.color;hx.fillRect(HIDItem.mapX,HIDItem.mapY,96,96);png_font.ctx=hx;png_font.drawText(HIDItem.letter,[HIDItem.mapX+32,HIDItem.mapY+8],blendColors("#FFFFFF",HIDItem.color,.5),4,"#221100")}};screen.clearAll=function(){if(!debug.showLayer.layer1){this.ctx.clearRect(this.GSTARTX,this.GSTARTY,this.GWIDTH,this.GHEIGHT)}};screen.printBox={setSize:function(){this.Width=screen.GWIDTH;this.Height=96;this.X=0;this.Y=screen.GHEIGHT-this.Height;this.aSizex=[32,64,128,this.Width,this.Width];this.aSizey=[32,32,48,48,this.Height];this.anim="none";this.frameMax=this.aSizex.length-1;this.targetFrame=this.frameMax},setup:function(imgPrintSet){this.imgPrintSet=imgPrintSet;this.setSize()},printSet:{background:{x:0,y:0,sizex:64,sizey:64},topLeftBox:{x:64,y:0,sizex:16,sizey:16},topRightBox:{x:112,y:0,sizex:16,sizey:16},bottomLeftBox:{x:64,y:48,sizex:16,sizey:16},bottomRightBox:{x:112,y:48,sizex:16,sizey:16},LeftBox:{x:64,y:16,sizex:16,sizey:32},RightBox:{x:112,y:16,sizex:16,sizey:32},TopBox:{x:80,y:0,sizex:32,sizey:16},BottomBox:{x:80,y:48,sizex:32,sizey:16},acceptUp:{x:0,y:64,sizex:16,sizey:16},acceptDown:{x:16,y:64,sizex:16,sizey:16},upArrow:{x:64,y:64,sizex:32,sizey:16},downArrow:{x:64,y:80,sizex:32,sizey:16}},printSet_05:{background:{x:0,y:0,sizex:64,sizey:64},topLeftBox:{x:160,y:64,sizex:8,sizey:8},topRightBox:{x:184,y:64,sizex:8,sizey:8},bottomLeftBox:{x:160,y:88,sizex:8,sizey:8},bottomRightBox:{x:184,y:88,sizex:8,sizey:8},LeftBox:{x:160,y:72,sizex:8,sizey:16},RightBox:{x:184,y:72,sizex:8,sizey:16},TopBox:{x:168,y:64,sizex:16,sizey:8},BottomBox:{x:168,y:88,sizex:16,sizey:8},acceptUp:{x:0,y:64,sizex:16,sizey:16},acceptDown:{x:16,y:64,sizex:16,sizey:16},upArrow:{x:64,y:64,sizex:32,sizey:16},downArrow:{x:64,y:80,sizex:32,sizey:16}},getIcon:function(i){return{x:parseInt(i%4)*64,y:parseInt(Math.floor(i/4))*64+96,sizex:64,sizey:64}},drawButtonAccept:function(){var frame=Math.floor(screen.frameCount/4)%2;if(frame==0){var accept=this.printSet.acceptUp}else{var accept=this.printSet.acceptDown}screen.ctx.drawImage(imgPrintSet,accept["x"],accept["y"],accept["sizex"],accept["sizey"],screen.GSTARTX+screen.GWIDTH-32,screen.GSTARTY+screen.GHEIGHT-32,accept["sizex"],accept["sizey"])},drawElement:function(element,x,y,sizex,sizey,imgPrintSet,select,size,ctx){size=typeof size==="undefined"?2:size;select=typeof select==="undefined"?0:select;ctx=typeof ctx==="undefined"?screen.ctx:ctx;ctx.drawImage(imgPrintSet,element["x"]+select*32*size,element["y"],element["sizex"],element["sizey"],screen.GSTARTX+x,screen.GSTARTY+y,sizex,sizey)},drawBoxAnimation:function(){if(this.anim=="none"){return}else if(this.anim=="box"){this.targetFrame=this.frameMax}else if(this.anim=="fadeIn"){if(this.targetFrame<this.frameMax)this.targetFrame++;else{this.anim="box";this.targetFrame=this.frameMax}}else if(this.anim=="fadeOut"){if(this.targetFrame>0)this.targetFrame--;else{this.anim="none";return}}screen.printBox.drawBox(Math.floor(screen.printBox.X+screen.printBox.Width/2-this.aSizex[this.targetFrame]/2),Math.floor(screen.printBox.Y+screen.printBox.Height/2-this.aSizey[this.targetFrame]/2),this.aSizex[this.targetFrame],this.aSizey[this.targetFrame]);if(this.anim=="box"){this.drawButtonAccept()}},drawArrow:function(upordown,x,y){var imgPrintSet=screen.printBox.imgPrintSet;var arrow=screen.printBox.printSet.upArrow;if(upordown=="down"){arrow=screen.printBox.printSet.downArrow}screen.printBox.drawElement(arrow,x,y,arrow.sizex,arrow.sizey,imgPrintSet)},drawBox:function(x,y,sizex,sizey,select,size,ctx){select=typeof select==="undefined"?0:select;size=typeof size==="undefined"?2:size;ctx=typeof ctx==="undefined"?screen.ctx:ctx;imgPrintSet=screen.printBox.imgPrintSet;if(size==2){var s=screen["printBox"]["printSet"]}else{var s=screen["printBox"]["printSet_05"]}if(select==0){screen.printBox.drawElement(s["background"],x,y,sizex,sizey,imgPrintSet,0,2,ctx)}screen.printBox.drawElement(s["topLeftBox"],x,y,s["topLeftBox"]["sizex"],s["topLeftBox"]["sizey"],imgPrintSet,select,size,ctx);screen.printBox.drawElement(s["TopBox"],x+s["topLeftBox"]["sizex"],y,sizex-s["topLeftBox"]["sizex"]-s["topRightBox"]["sizex"],s["TopBox"]["sizey"],imgPrintSet,select,size,ctx);screen.printBox.drawElement(s["topRightBox"],x+sizex-s["topRightBox"]["sizex"],y,s["topRightBox"]["sizex"],s["topRightBox"]["sizey"],imgPrintSet,select,size,ctx);screen.printBox.drawElement(s["LeftBox"],x,y+s["topLeftBox"]["sizey"],s["LeftBox"]["sizex"],sizey-s["topLeftBox"]["sizey"]-s["bottomLeftBox"]["sizey"],imgPrintSet,select,size,ctx);screen.printBox.drawElement(s["RightBox"],x+sizex-s["topRightBox"]["sizex"],y+s["topRightBox"]["sizey"],s["RightBox"]["sizex"],sizey-s["topRightBox"]["sizey"]-s["bottomRightBox"]["sizey"],imgPrintSet,select,size,ctx);screen.printBox.drawElement(s["bottomLeftBox"],x,y+sizey-s["bottomLeftBox"]["sizey"],s["bottomLeftBox"]["sizex"],s["bottomLeftBox"]["sizey"],imgPrintSet,select,size,ctx);screen.printBox.drawElement(s["BottomBox"],x+s["bottomLeftBox"]["sizex"],y+sizey-s["bottomRightBox"]["sizey"],sizex-s["bottomLeftBox"]["sizex"]-s["bottomRightBox"]["sizex"],s["BottomBox"]["sizey"],imgPrintSet,select,size,ctx);screen.printBox.drawElement(s["bottomRightBox"],x+sizex-s["bottomRightBox"]["sizex"],y+sizey-s["bottomRightBox"]["sizey"],s["bottomRightBox"]["sizex"],s["bottomRightBox"]["sizey"],imgPrintSet,select,size,ctx)}};screen.effectPixelize2=function(pixelation){var imageData=this.ctx.getImageData(this.GSTARTX,this.GSTARTY,this.GWIDTH,this.GHEIGHT);var data=imageData.data;for(var y=0;y<this.GHEIGHT;y+=pixelation){for(var x=0;x<this.GWIDTH;x+=pixelation){var red=data[(this.GWIDTH*y+x)*4];var green=data[(this.GWIDTH*y+x)*4+1];var blue=data[(this.GWIDTH*y+x)*4+2];for(var n=0;n<pixelation;n++){for(var m=0;m<pixelation;m++){if(x+m<this.GWIDTH){data[(this.GWIDTH*(y+n)+(x+m))*4]=red;data[(this.GWIDTH*(y+n)+(x+m))*4+1]=green;data[(this.GWIDTH*(y+n)+(x+m))*4+2]=blue}}}}}this.ctx.putImageData(imageData,0,0)};screen.effectPixelize=function(pixelation){this.ctx.drawImage(this.canvas,this.GSTARTX,this.GSTARTY,this.GWIDTH,this.GHEIGHT,this.GSTARTX,this.GSTARTY,pixelation,pixelation);this.ctx.drawImage(this.canvas,this.GSTARTX,this.GSTARTY,pixelation,pixelation,this.GSTARTX,this.GSTARTY,this.GWIDTH,this.GHEIGHT)};screen.effectTension1=function(intensity){this.ctx.drawImage(this.canvas,this.GSTARTX,this.GSTARTY,Math.floor(this.GWIDTH/2),this.GHEIGHT,Math.floor(this.GSTARTX-this.GWIDTH*intensity/128/2),this.GSTARTY,Math.floor(this.GWIDTH/4),this.GHEIGHT);this.ctx.drawImage(this.canvas,this.GSTARTX+this.GWIDTH/2,this.GSTARTY,Math.floor(this.GWIDTH/2),this.GHEIGHT,Math.floor(this.GSTARTX+this.GWIDTH/2+this.GWIDTH*intensity/128/2),this.GSTARTY,Math.floor(this.GWIDTH/4),this.GHEIGHT);this.ctx.fillStyle="#000000";this.ctx.fillRect(Math.floor(this.GSTARTX+this.GWIDTH/2-this.GWIDTH*intensity/128/2),this.GSTARTY,Math.floor(this.GWIDTH*intensity/128),this.GHEIGHT)};screen.effectColor=function(opacity,color){this.ctx.save();this.ctx.fillStyle=color;this.ctx.globalAlpha=opacity;this.ctx.fillRect(this.GSTARTX,this.GSTARTY,this.GWIDTH,this.GHEIGHT);this.ctx.restore()};screen.shakeEffect=function(){if(this.shaking){if(this.shakes>0){this.shakes--;if(this.shaking=="h"){this.GSTARTX=Math.floor(16*Math.sin(3*this.shakes/4)*this.shakes/16)+this.ORIGINALGSTARTX}else{this.GSTARTY=Math.floor(16*Math.sin(3*this.shakes/4)*this.shakes/16)+this.ORIGINALGSTARTY}}else if(this.shakes==0){this.shakes--;this.GSTARTX=this.ORIGINALGSTARTX;this.GSTARTY=this.ORIGINALGSTARTY;this.shaking=false}}};screen.shakeScreen=function(horv){horv=typeof horv==="undefined"?"h":horv;this.shakes=typeof this.shakes==="undefined"?0:this.shakes;this.shakes+=16;if(horv=="h"){this.shaking="h"}else{this.shaking="v"}};screen.effects={selected:null,startFrame:0,endFrame:0,intensity:[8,16,24,32,48,64,128],keepAfter:false,fadeIn:function(params){var changeEffect=params[0];var shouldKeepAfter=params[1];screen.effects.startFrame=screen.frameCount;screen.effects.endFrame=screen.effects.intensity.length;screen.effects.selected=changeEffect;if(shouldKeepAfter=="keepEffect")screen.effects.keepAfter=true;else screen.effects.keepAfter=false},fadeOut:function(params){var changeEffect=params[0];var shouldKeepAfter=params[1];screen.effects.startFrame=screen.frameCount;screen.effects.endFrame=screen.effects.intensity.length;screen.effects.selected=changeEffect;if(shouldKeepAfter=="keepEffect"){screen.effects.keepAfter=true}else screen.effects.keepAfter=false},noEffect:function(){screen.effects.selected=null}};screen.drawEffects=function(){if(screen.effects.selected==null){return}if(screen.effects.selected=="pixelizeFadeIn"){var frameToDraw=screen.frameCount-screen.effects.startFrame;if(frameToDraw>=screen.effects.endFrame){frameToDraw=screen.effects.endFrame-1;if(!screen.effects.keepAfter){screen.effects.noEffect()}}screen.effectPixelize(screen.effects.intensity[frameToDraw])}if(screen.effects.selected=="pixelizeFadeOut"){var frameToDraw=screen.effects.endFrame-screen.frameCount+screen.effects.startFrame;if(frameToDraw<=0){frameToDraw=0;if(!screen.effects.keepAfter){screen.effects.noEffect()}}screen.effectPixelize(screen.effects.intensity[frameToDraw])}if(screen.effects.selected=="blackFadeOut"){var frameToDraw=screen.frameCount-screen.effects.startFrame;if(frameToDraw>=screen.effects.endFrame){frameToDraw=screen.effects.endFrame-1;if(!screen.effects.keepAfter){screen.effects.noEffect()}}screen.effectColor(screen.effects.intensity[frameToDraw]/128,"#000000")}if(screen.effects.selected=="blackFadeIn"){var frameToDraw=screen.effects.endFrame-screen.frameCount+screen.effects.startFrame;if(frameToDraw<=0){frameToDraw=0;if(!screen.effects.keepAfter){screen.effects.noEffect()}}screen.effectColor(screen.effects.intensity[frameToDraw]/128,"#000000")}if(screen.effects.selected=="whiteFadeOut"){var frameToDraw=screen.frameCount-screen.effects.startFrame;if(frameToDraw>=screen.effects.endFrame){frameToDraw=screen.effects.endFrame-1;if(!screen.effects.keepAfter){screen.effects.noEffect()}}screen.effectColor(screen.effects.intensity[frameToDraw]/128,"#FFFFFF")}if(screen.effects.selected=="whiteFadeIn"){var frameToDraw=screen.effects.endFrame-screen.frameCount+screen.effects.startFrame;if(frameToDraw<=0){frameToDraw=0;if(!screen.effects.keepAfter){screen.effects.noEffect()}}screen.effectColor(screen.effects.intensity[frameToDraw]/128,"#FFFFFF")}if(screen.effects.selected=="tension1"){var frameToDraw=screen.frameCount-screen.effects.startFrame-1;if(frameToDraw>=screen.effects.endFrame){frameToDraw=screen.effects.endFrame-1;if(!screen.effects.keepAfter){screen.effects.noEffect()}}screen.effectTension1(screen.effects.intensity[frameToDraw])}};function compareChars(a,b){if(a.mapy==b.mapy){return a.mapx<b.mapx?-1:a.mapx>b.mapx?1:0}else{return a.mapy<b.mapy?-1:1}}camera.drawChars=function(){chars.sort(compareChars);var count=chars.length;for(var i=0;i<count;i++){var item=chars[i];camera.drawChar(item)}};screen.drawMonsters=function(){for(var i=0;i<battle.monster.length;i++){screen.drawMonster(battle.monster[i],[Math.floor((i+1)*screen.GWIDTH/(battle.monster.length+1)-64),Math.floor(screen.GHEIGHT/3)])}};screen.drawMenu=function(menu){var maxOnScreen=menu.maxOnScreen;var maxItems=menu.itemsLength;var selectedIndex=menu.selectedItem.index;if(typeof menu.firstItem==="undefined"){menu.firstItem=0;menu.finalItem=Math.min(maxItems,maxOnScreen)}if(selectedIndex>=menu.finalItem){menu.finalItem=selectedIndex+1;menu.firstItem=menu.finalItem-maxOnScreen}else if(selectedIndex<menu.firstItem){menu.firstItem=selectedIndex;menu.finalItem=menu.firstItem+maxOnScreen}if(!menu.wait){if(menu.finalItem<maxItems){screen.printBox.drawArrow("down",menu["drawx"]+menu["width"]-32,menu["drawy"]+menu["height"]+16)}if(menu.firstItem>0){screen.printBox.drawArrow("up",menu["drawx"]+menu["width"]-32,menu["drawy"]+menu["height"])}}screen.printBox.drawBox(menu["drawx"],menu["drawy"],menu["width"],menu["height"],0,menu.menuScale);var k=0;for(var i=menu.firstItem;i<menu.finalItem;i+=1){if(menu.items[Object.keys(menu.items)[i]].selected){if(menu.wait){screen.printBox.drawBox(menu["drawx"]+4*menu.menuScale,menu["drawy"]+8+menu.fontHeight*k,menu["width"]-8*menu.menuScale,16*menu.menuScale,1,menu.menuScale)}else{screen.printBox.drawBox(menu["drawx"]+4*menu.menuScale,menu["drawy"]+8+menu.fontHeight*k,menu["width"]-8*menu.menuScale,16*menu.menuScale,1+Math.floor(screen.frameCount/4)%2,menu.menuScale)}if(isInt(menu.items[Object.keys(menu.items)[i]].icon)){var imgPrintSet=screen.printBox.imgPrintSet;var icon=screen.printBox.getIcon(menu.items[Object.keys(menu.items)[i]].icon);screen.printBox.drawBox(menu["drawx"]+menu["width"],menu["drawy"],icon.sizex+16,icon.sizey+16,0);screen.printBox.drawElement(icon,menu["drawx"]+menu["width"]+8,menu["drawy"]+8,icon.sizex,icon.sizey,imgPrintSet,0)}}screen.drawText(Object.keys(menu.items)[i],menu["drawx"]+16,menu["drawy"]+32+k*menu.fontHeight,menu.menuScale);k+=1}};screen.drawStatus=function(heroch){var hero=heroch;var statx=engine.mapMenu.drawx+engine.mapMenu.width;var staty=engine.mapMenu.drawy;var statw=screen.GWIDTH-8-(engine.mapMenu.drawx+engine.mapMenu.width);var stath=screen.GHEIGHT-16;screen.printBox.drawBox(statx,staty,statw,stath,0,2);screen.drawFace(resources.faceset,heroch.face,[statx+112,staty+16]);var stats=heroch.name+"\n"+"st: "+heroch.st+"\n"+"dx: "+heroch.dx+"\n"+"iq: "+heroch.iq+"\n"+"hp: "+heroch.hp+"/"+heroch.hpmax+"\n"+"level: "+heroch.level+"\n"+"xp: "+heroch.xp+"/"+heroch.xpnextlevel+"\n";screen.drawText(stats,statx+8,staty+8+24,2);screen.printBox.drawButtonAccept()};screen.showpicture=function(){if(screen.pictureStack.length>0){for(var i=0;i<screen.pictureStack.length;i+=1){if(screen.pictureStack[i].sys){screen.drawImage(resources.syspictures[screen.pictureStack[i].image],screen.pictureStack[i].position)}else{screen.drawImage(resources.pictures[screen.pictureStack[i].image],screen.pictureStack[i].position)}}}};screen.clearPicture=function(){for(var member in screen.pictureStack)delete screen.pictureStack[member];screen.pictureStack.length=0};screen.drawAlert=function(text,index){var xpos=Math.floor(screen.GWIDTH/2-text.length*8);screen.drawText(text,xpos,index*32+32)};screen.drawAlerts=function(){for(var i=0;i<engine.alertStack.length;i++){screen.drawAlert(engine.alertStack[i][0],i)}};screen.loop=function(){screen.frameCount+=1;screen.clearAll();if(!screen.paused){screen.shakeEffect();if(engine.state=="map"){if(debug.showLayer.layer1)camera.drawMapLayer(engine.currentLevel,"layer1");if(debug.showLayer.layer2)camera.drawMapLayer(engine.currentLevel,"layer2");if(debug.showLayer.layer3)camera.drawChars();if(debug.showLayer.layer4)camera.drawMapLayer(engine.currentLevel,"layer4");screen.rains.DrawRain()}else if(engine.state=="startScreen"){}else if(engine.state=="battle"){dist.test(dist.efnumb[0]);screen.drawMonsters()}screen.showpicture();screen.drawEffects();screen.drawHID();var allMenusLenght=menus.allMenus.length;for(var menuToDraw=allMenusLenght-1;menuToDraw>=0;menuToDraw--){if(menus.allMenus[menuToDraw].enabled){screen.drawMenu(menus.allMenus[menuToDraw])}}if(battle.herotoshowstatus){screen.drawStatus(battle.herotoshowstatus)}screen.printBox.drawBoxAnimation();screen.drawAlerts();printer.update()}debug.FPS.draw();screen.requestAnimationFrame.call(window,screen.loop)};debug={};debug.showLayer={layer1:true,layer2:true,layer3:true,layer4:true};debug.FPS={counter:0,FPS:0,show:false,draw:function(){this.counter+=1;if(this.show){screen.drawText(this.FPS.toString()+" fps",screen.GSTARTX+2,screen.GSTARTY+32)}},loop:function(){this.FPS=this.counter;this.counter=0;this.timer=setTimeout("debug.FPS.loop()",1e3)}};
</script>

<script>
var HID={scale:1,bsz:96,offset:416,axeNotNull:.4,inputs:{up:{letter:"W",active:false,mapX:96,mapY:0,color:"#111111",gamepad:function(pad){if(!(typeof pad==="undefined")){return pad.axes[1]<-HID.axeNotNull}else{return false}}},left:{letter:"A",active:false,mapX:0,mapY:96,color:"#111111",gamepad:function(pad){if(!(typeof pad==="undefined")){return pad.axes[0]<-HID.axeNotNull}else{return false}}},down:{letter:"S",active:false,mapX:96,mapY:192,color:"#111111",gamepad:function(pad){if(!(typeof pad==="undefined")){return pad.axes[1]>HID.axeNotNull}else{return false}}},right:{letter:"D",active:false,mapX:192,mapY:96,color:"#111111",gamepad:function(pad){if(!(typeof pad==="undefined")){return pad.axes[0]>HID.axeNotNull}else{return false}}},accept:{letter:"I",active:false,mapX:304,mapY:32,color:"#127826",gamepad:function(pad){if(!(typeof pad==="undefined")){return pad.buttons[0].pressed}else{return false}}},cancel:{letter:"J",active:false,mapX:304,mapY:160,color:"#ed1c24",gamepad:function(pad){if(!(typeof pad==="undefined")){return pad.buttons[1].pressed}else{return false}}}},debugKeys:{resize:{letter:"0",toggle:function(){screen.resize()}},layer1:{letter:"1",toggle:function(){debug.showLayer.layer1=!debug.showLayer.layer1;if(debug.showLayer.layer1){actions.alert("layer1 shown.")}else{actions.alert("layer1 hidden.")}}},layer2:{letter:"2",toggle:function(){debug.showLayer.layer2=!debug.showLayer.layer2;if(debug.showLayer.layer2){actions.alert("layer2 shown.")}else{actions.alert("layer2 hidden.")}}},layer3:{letter:"3",toggle:function(){debug.showLayer.layer3=!debug.showLayer.layer3;if(debug.showLayer.layer3){actions.alert("layer3 shown.")}else{actions.alert("layer3 hidden.")}}},layer4:{letter:"4",toggle:function(){debug.showLayer.layer4=!debug.showLayer.layer4;if(debug.showLayer.layer4){actions.alert("layer4 shown.")}else{actions.alert("layer4 hidden.")}}}},processGamepad:function(){if(!(typeof HID.gamepads==="undefined")){if(HID.gamepads.length>0){for(var i=0;i<HID.gamepads.length;++i){var pad=navigator.getGamepads()[HID.gamepads[i]];if(!(typeof pad==="undefined")){for(var tag in HID.inputs){var HIDItem=HID.inputs[tag];if(HIDItem.gamepad(pad)){HIDItem.active=true}else{HIDItem.active=false}}}}}}},clearInputs:function(){for(var tag in HID.inputs){var HIDItem=HID.inputs[tag];HIDItem.release=false}},cleanInputs:function(){for(var tag in HID.inputs){var HIDItem=HID.inputs[tag];HIDItem.active=false}},log:function(text){var tag=document.getElementById("log");tag.innerHTML=text},keyDown:function(e){var evtobj=window.event?event:e;var unicode=evtobj.charCode?evtobj.charCode:evtobj.keyCode;for(var key in HID.inputs){var HIDItem=HID.inputs[key];if(unicode==HIDItem.unicode){HIDItem.active=true;return}}},keyUp:function(e){var evtobj=window.event?event:e;var unicode=evtobj.charCode?evtobj.charCode:evtobj.keyCode;for(var key in HID.inputs){var HIDItem=HID.inputs[key];if(unicode==HIDItem.unicode){HIDItem.active=false;return}}for(var key in HID.debugKeys){var HIDItem=HID.debugKeys[key];if(unicode==HIDItem.unicode){HIDItem.toggle();return}}},setupTouchZone:function(_screen){this.screen=_screen;this.touchzone=this.screen.canvas},setupKeyboardListeners:function(){document.onkeydown=HID.keyDown;document.onkeyup=HID.keyUp},handleTouchDown:function(evnt){evnt.preventDefault();HID.processTouches(evnt.touches,"down")},handleTouchMove:function(evnt){evnt.preventDefault();HID.processTouches(evnt.touches,"move")},handleTouchUp:function(evnt){evnt.preventDefault();HID.processTouches(evnt.touches,"up")},processTouches:function(touches,kind){for(var tag in HID.inputs){var HIDItem=HID.inputs[tag];var touched=false;var offsetTop=this.screen.canvas.offsetTop,offsetLeft=this.screen.canvas.offsetLeft;scale=this.screen.currentWidth/this.screen.WIDTH;for(var i=0;i<touches.length;i++){var position={x:(touches[i].pageX-offsetLeft)/scale,y:(touches[i].pageY-offsetTop)/scale};if(position.x>HIDItem.mapX&&position.y>this.offset+HIDItem.mapY){if(position.x<HIDItem.mapX+this.bsz&&position.y<this.offset+HIDItem.mapY+this.bsz){touched=true}}}if(touched){HIDItem.active=true;if(kind=="down"){HIDItem.release=true}}else{HIDItem.active=false}}for(var menuTag in menus.allMenus){var aMenu=menus.allMenus[menuTag];if(aMenu.enabled&&!aMenu.wait){var maxItems=aMenu.itemsLength;for(var menuItemTag in aMenu.items){var menuItem=aMenu.items[menuItemTag];var touched=false;var offsetTop=this.screen.canvas.offsetTop,offsetLeft=this.screen.canvas.offsetLeft;scale=this.screen.currentWidth/this.screen.WIDTH;for(var i=0;i<touches.length;i++){var position={x:(touches[i].pageX-offsetLeft)/scale,y:(touches[i].pageY-offsetTop)/scale};if(position.x>screen.GSTARTX+aMenu.drawx&&position.y>screen.GSTARTY+aMenu.drawy+menuItem.itemy-32){if(position.x<screen.GSTARTX+aMenu.drawx+aMenu.width&&position.y<screen.GSTARTY+aMenu.drawy+menuItem.itemy){touched=true}}}if(touched){if(kind=="down"&&menuItem.selected){HID.inputs["accept"].active=true;return}for(var z=0;z<maxItems;z+=1){aMenu.items[Object.keys(aMenu.items)[z]].selected=false}menuItem.selected=true;aMenu.selectedItem=menuItem}}}}},setupListeners:function(){window.addEventListener("touchstart",HID.handleTouchDown,false);window.addEventListener("touchmove",HID.handleTouchMove,false);window.addEventListener("touchend",HID.handleTouchUp,false);window.addEventListener("gamepadconnected",function(e){setTimeout(function(){if(typeof HID.gamepads==="undefined"){HID.gamepads=[]}HID.gamepads.push(e.gamepad.index);actions.alert("gamepad connected!")},1200)});window.addEventListener("gamepaddisconnected",function(e){HID.gamepads=[];HID.cleanInputs();HID.clearInputs();actions.alert("gamepad disconnected.")});setTimeout(function(){if(navigator.getGamepads().length>0){var gamepads=navigator.getGamepads();for(var pad=0;pad<gamepads.length;pad++){if(!(typeof gamepads[pad]==="undefined")){HID.gamepads=[]}}for(var pad=0;pad<gamepads.length;pad++){if(!(typeof gamepads[pad]==="undefined")){HID.gamepads.push(pad);actions.alert("gamepad connected!")}}}},1e3)},setup:function(screentosetup){for(var key in HID.inputs){var HIDItem=HID.inputs[key];if("letter"in HIDItem){HIDItem["unicode"]=HIDItem.letter.charCodeAt(0)}}this.setupTouchZone(screentosetup);this.setupListeners();this.setupKeyboardListeners()}};
</script>

<script>
png_font={textDrawed:[],textUTF8Array:[],fontUrl:null,setup:function(drawingContext,fontImageUrl,callback){if(typeof callback==="undefined"){callback=function(){}}this.ctx=drawingContext;this.fontImage=new Image;this.fontImage.onload=function(){var event=new Event("png_font_loaded");document.dispatchEvent(event);callback()};if(typeof fontImageUrl==="undefined"){fontImageUrl="img/unifont.png"}this.fontImage.src=fontImageUrl},toCharCodeArray:function(str){var arrCharCode=[];for(var i=0;i<str.length;i++){var charcode=str.charCodeAt(i);arrCharCode.push(charcode)}return arrCharCode},getCharwidthFromCharcode:function(chr){var xchr=chr%256;var ychr=parseInt(chr/256);var charWidth=16;if(ychr<32){charWidth=8}return charWidth},predictSize:function(text,pos,size,wrap){if(typeof size==="undefined"||size===null){size=1}if(typeof wrap==="undefined"||size===null){wrap=[this.ctx.canvas.width-pos[0],this.ctx.canvas.height-pos[1],0]}var wrapped2DArray;var missing;[wrapped2DArray,missing]=this.wrapText(text,wrap,size);var width=0;var height=0;for(var i=0;i<wrapped2DArray.length;i++){height+=this.getHeight(size);var charCodeArray=wrapped2DArray[i];var textWidth=0;for(var j=0;j<charCodeArray.length;j++){textWidth+=this.getCharwidthFromCharcode(charCodeArray[j])}if(textWidth>width){width=textWidth}}return width*1024+height},getTextWidth:function(text,size){if(typeof size==="undefined"){size=1}var textWidth=0;var charCodeArray=this.toCharCodeArray(text);for(var i=0;i<charCodeArray.length;i++){textWidth+=this.getCharwidthFromCharcode(charCodeArray[i])}return textWidth*size},getHeight:function(size){return size*16},drawChr:function(ctx,img,chr,pos){var xchar=parseInt(16*(chr%256));var ychar=parseInt(16*parseInt(chr/256));var charWidth=this.getCharwidthFromCharcode(chr);ctx.drawImage(img,xchar,ychar,16,16,pos[0],pos[1],16,16);return charWidth},createBufferCanvas:function(width,height){var buffer=document.createElement("canvas");buffer.style["image-rendering"]="pixelated";buffer.width=width;buffer.height=height;var bx=buffer.getContext("2d");bx.mozImageSmoothingEnabled=false;bx.imageSmoothingEnabled=false;return buffer},drawTextCanvas:function(ctx,utf8Array,pos,color,size){var width=16*utf8Array.length;var height=16;var buffer=this.createBufferCanvas(width,height);var bx=buffer.getContext("2d");var charWidth=0;var charTotalWidth=0;var chrPos=[0,0];for(var i=0;i<utf8Array.length;i++){var char=utf8Array[i];charWidth=this.drawChr(bx,this.fontImage,char,chrPos);chrPos[0]+=charWidth;charTotalWidth+=charWidth}if(typeof color!=="undefined"||color!==null){bx.fillStyle=color;bx.globalCompositeOperation="source-in";bx.fillRect(0,0,width,height)}if(typeof size==="undefined"||size===null||size==1){ctx.drawImage(buffer,pos[0],pos[1])}else{var bufferSize=this.createBufferCanvas(width*size,height*size);var bSx=bufferSize.getContext("2d");bSx.drawImage(buffer,0,0,width*size,height*size);ctx.drawImage(bufferSize,pos[0],pos[1])}return charTotalWidth},drawTextShadow:function(utf8Array,color,size,shadowcolor){if(typeof size==="undefined"||size===null){size=1}var charTotalWidth=0;var width=16*utf8Array.length*size;var height=16*size;var buffer=this.createBufferCanvas(width+1,height+1);var bx=buffer.getContext("2d");this.drawTextCanvas(bx,utf8Array,[size,size],shadowcolor,size);charTotalWidth=this.drawTextCanvas(bx,utf8Array,[0,0],color,size);return[buffer,charTotalWidth+size]},wrapText:function(text,wrap,size){if(this.textDrawed!==text){this.textUTF8Array=this.toCharCodeArray(text);this.textDrawed=text}function missingText(text,utf82DArray){var flatUtf8Array=[];for(var i=0;i<utf82DArray.length;i++){flatUtf8Array=flatUtf8Array.concat(utf82DArray[i])}var doneText=String.fromCharCode.apply(null,flatUtf8Array);var ending=text.substring(doneText.length);return ending}var wrapped2DArray=[];var missing="";var width=0;var line=0;var word=[];var wordWidth=0;wrapped2DArray[line]=[];for(var i=0;i<=this.textUTF8Array.length;i++){if(this.textUTF8Array[i]!=32&&i!=this.textUTF8Array.length&&this.textUTF8Array[i]!=10){wordWidth=wordWidth+this.getCharwidthFromCharcode(this.textUTF8Array[i])*size;word.push(this.textUTF8Array[i])}else{if(width+wordWidth<wrap[0]){wrapped2DArray[line]=wrapped2DArray[line].concat(word).concat([32]);width=width+wordWidth+8;if(this.textUTF8Array[i]==10){line++;if(line*16*size>=wrap[1]){missing=missingText(text,wrapped2DArray);return[wrapped2DArray,missing];break}wrapped2DArray.push([]);width=wordWidth+8;wrapped2DArray[line]=[]}wordWidth=0;word=[]}else{line++;if((line+1)*16*size>=wrap[1]){missing=missingText(text,wrapped2DArray);return[wrapped2DArray,missing];break}wrapped2DArray.push([]);width=wordWidth+8;wrapped2DArray[line]=[];wrapped2DArray[line]=wrapped2DArray[line].concat(word).concat([32]);wordWidth=0;word=[]}}}return[wrapped2DArray,missing]},drawText:function(text,pos,color,size,shadow,wrap){if(typeof size==="undefined"||size===null){size=1}if(typeof wrap==="undefined"||size===null){wrap=[this.ctx.canvas.width-pos[0],this.ctx.canvas.height-pos[1],0]}var wrapped2DArray;var missing;[wrapped2DArray,missing]=this.wrapText(text,wrap,size);for(var i=0;i<wrapped2DArray.length;i++){var textUTF8Array=wrapped2DArray[i];if(typeof shadow==="undefined"||shadow===null||shadow==false){this.drawTextCanvas(this.ctx,textUTF8Array,[pos[0],pos[1]+i*16*size],color,size)}else{var buffer;[buffer,charTotalWidth]=this.drawTextShadow(textUTF8Array,color,size,shadow);this.ctx.drawImage(buffer,pos[0],pos[1]+i*16*size)}}return missing}};
</script>

<script>
var printer={};printer.buffer=[];printer.btx=[];printer.isShown=false;printer.startingBox=[];printer.textWidth=screen.GWIDTH-32;printer.textHeight=65;printer.drawText=function(text,x,y){return printer.buffer};printer.textBoxes=function(_text){printer.startingBox.push(printer.buffer.length);var i=0;var remaining_text=_text;while(remaining_text!=""){var boxbuffer=document.createElement("canvas");boxbuffer.width=printer.textWidth;boxbuffer.height=printer.textHeight;png_font.ctx=boxbuffer.getContext("2d");remaining_text=png_font.drawText(remaining_text,[0,0],"#FFFFFF",2,"#221100");printer.buffer.push(boxbuffer);i++}return i};printer.showText=function(_text){var total_boxes=printer.textBoxes(_text);for(var nboxes=0;nboxes<total_boxes;nboxes++){engine.atomStack.unshift([function(){printer.nextBox();engine.waitTime(300)},""]);engine.atomStack.unshift(["block",null]);engine.atomStack.unshift([engine.waitForKey,true])}printer.isShown=true;printBox.show()};printer.dismissText=function(){printer.isShown=false;printBox.close()};printer.nextBox=function(){printer.buffer.shift();if(printer.buffer.length<=printer.startingBox[0]){printer.dismissText();printer.startingBox.shift();return}};printer.update=function(){if(printer.isShown&&printBox.isShown()){screen.drawImage(printer.buffer[0],[screen.printBox.X+16,screen.printBox.Y+8])}};
</script>

<script>
var title={};title.setup=function(){title.startMenu=new menu({start:{action:[function(){actions.showText("let's play!");actions.fadeOut("blackFadeOut;keepEffect");actions.teleport(Math.floor(resources.init["Player"]["initPosX"]/32)+";"+(Math.floor(resources.init["Player"]["initPosY"]/32)+1)+";"+resources.init["World"]["initLevel"]);engine.actions.runScript(resources.init["World"]["initActions"])},function(){actions.stopPicture("")},function(){actions.fadeIn("blackFadeIn;doNotKeep")},"exit"],index:0},exit:{action:"exit",index:1}},undefined,true);menus.setParent(title.startMenu);var onTitleLoad=function(){title.startMenu.activate();actions.showPicture("title;0;0;sys");setTimeout(function(){if(engine.state=="startScreen"){engine.actions.showPicture(["controllers","8",(screen.GHEIGHT-32).toString(),"sys"])}},1e3);setTimeout(function(){if(engine.state=="startScreen"){engine.actions.showPicture(["keys2","160","24","sys"])}},4e3);setTimeout(function(){if(engine.state=="startScreen"){engine.actions.stopPicture("");engine.actions.showPicture(["title","0","0","sys"]);engine.actions.showPicture(["keys1","150","16","sys"]);engine.actions.showPicture(["controllers","8",(screen.GHEIGHT-32).toString(),"sys"])}},1e4)};engine.atomStack.push([onTitleLoad])};title.startScreen=function(){title.update()};title.update=function(){if(printer.isShown)return;if(player.steps==0){if(HID.inputs["cancel"].active){HID.inputs["cancel"].active=false;title.startMenu.activate()}}};
</script>

<script>
var dist={};dist.setup=function(viewCanvas,backgroundImage,alpha){dist.alpha=alpha;dist.tickssy=0;dist.bfx={};dist.efnumb=[];dist.efnumb[0]=1;dist.bfx.effectsrom=[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,0,4,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,4,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,4,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,4,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,3,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,3,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,3,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,3,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,2,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,2,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,2,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,2,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,1,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,1,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,1,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,1,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,4,0,128,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,2,0,128,0,0,0,0,0,0,0,2,0,0],[0,0,1,0,2,255,255,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,4,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,4,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,4,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,4,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,3,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,3,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,3,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,3,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,2,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,2,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,2,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,2,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,1,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,1,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,1,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,1,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,4,0,128,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,2,0,128,0,0,0,0,0,0,0,2,0,0],[0,0,2,0,2,255,255,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,4,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,4,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,4,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,4,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,3,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,3,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,3,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,3,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,2,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,2,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,2,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,2,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,1,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,1,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,1,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,1,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,4,0,128,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,2,0,128,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,2,255,255,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,4,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,4,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,4,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,4,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,3,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,3,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,3,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,3,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,2,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,2,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,2,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,2,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,1,0,8,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,1,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,1,0,32,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,1,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,4,0,128,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,2,0,128,0,0,0,0,0,0,0,2,0,0],[0,0,4,0,2,255,255,0,0,0,0,0,0,0,2,0,0],[120,0,4,0,2,0,32,0,0,0,0,0,0,1,10,0,0],[120,0,1,0,2,0,32,0,0,0,0,0,0,1,10,0,0],[120,0,2,0,2,0,32,0,0,0,0,0,0,1,10,0,0],[120,0,3,0,2,0,32,0,0,0,0,0,0,1,10,0,0],[255,0,3,0,2,0,0,0,0,0,0,0,0,1,0,0,0],[255,0,3,0,2,0,255,0,0,0,0,0,0,255,0,0,0],[255,0,1,0,2,0,0,0,0,0,0,0,0,1,0,0,0],[255,0,1,0,2,0,255,0,0,0,0,0,0,255,0,0,0],[0,0,3,0,2,0,128,0,0,2,0,0,0,0,0,0,0],[0,0,3,0,2,0,128,0,128,0,0,0,0,0,0,0,0],[0,1,3,0,4,0,64,0,0,1,0,0,0,0,0,2,0],[0,1,3,0,4,0,64,0,0,3,0,0,0,0,0,254,255],[0,4,1,0,8,0,64,128,0,0,254,255,0,0,1,0,0],[0,4,1,0,0,0,64,128,0,0,2,0,0,0,255,0,0],[88,2,3,0,0,0,0,0,0,1,0,0,0,0,0,3,0],[88,2,3,0,0,0,0,0,8,8,0,0,0,0,0,253,255],[0,2,3,0,0,0,0,0,0,2,0,0,0,0,0,255,255],[0,2,3,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[240,0,3,0,0,0,0,0,224,2,0,0,0,0,0,254,255],[240,0,3,0,0,0,0,0,0,0,0,0,0,0,0,2,0],[240,0,1,0,4,0,128,1,0,0,254,255,156,255,1,0,0],[240,0,1,32,2,64,34,241,0,0,2,0,100,0,255,0,0],[0,1,4,0,2,0,64,2,0,1,2,0,0,0,1,2,0],[0,1,4,0,4,0,64,2,0,3,254,255,0,0,255,254,255],[0,0,1,128,0,0,8,1,0,0,0,0,0,0,0,0,0],[0,1,1,0,4,0,0,2,0,0,0,0,128,0,0,0,0],[0,1,1,0,4,0,128,2,0,0,0,0,128,255,0,0,0],[244,1,1,0,2,0,0,2,0,0,0,0,128,0,0,0,0],[244,1,1,0,2,0,250,2,0,0,0,0,128,255,0,0,0],[244,1,1,0,2,0,0,10,0,0,0,0,80,0,0,0,0],[244,1,1,0,2,64,156,10,0,0,0,0,176,255,0,0,0],[240,0,3,0,2,0,8,2,0,0,0,0,0,0,0,1,0],[224,1,3,0,2,0,8,2,0,240,0,0,0,0,0,254,255],[240,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[180,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[104,1,1,0,1,0,0,2,0,0,0,0,128,0,0,0,0],[104,1,1,0,1,0,0,2,0,0,0,0,64,0,0,0,0],[0,0,2,0,16,128,250,10,0,0,0,0,0,0,0,0,0],[224,1,2,0,2,0,16,0,0,0,0,0,0,0,2,0,0],[240,0,1,0,2,0,16,0,0,0,0,0,0,0,2,0,0],[0,0,3,224,0,0,16,0,0,0,0,0,0,0,2,0,0],[0,1,3,0,4,0,0,2,0,0,0,0,128,0,0,0,0],[0,1,3,0,4,0,128,2,0,0,0,0,128,255,0,0,0],[224,1,3,0,2,0,4,2,0,1,0,0,0,0,0,2,0],[224,1,3,0,2,0,4,2,192,4,0,0,0,0,0,254,255],[0,0,3,0,3,0,64,0,0,0,0,0,0,0,2,0,0],[0,0,3,0,4,0,32,0,0,0,0,0,0,0,2,0,0],[0,1,3,0,4,0,0,2,0,0,0,0,128,0,0,0,0],[0,1,3,0,4,0,128,2,0,0,0,0,128,255,0,0,0],[0,1,3,0,4,0,0,2,0,0,0,0,150,0,0,0,0],[0,1,3,0,4,0,150,2,0,0,0,0,106,255,0,0,0],[104,1,4,0,1,0,0,0,0,0,0,0,60,0,2,0,0],[104,1,4,0,1,96,84,0,0,0,0,0,196,255,2,0,0],[0,0,3,0,1,0,4,0,0,0,0,0,0,0,2,0,0],[240,0,4,0,1,0,0,0,0,0,0,0,90,0,2,0,0],[240,0,4,0,1,96,84,0,0,0,0,0,166,255,2,0,0],[254,1,3,0,2,0,0,0,0,0,0,0,128,0,0,0,0],[254,1,3,0,2,0,255,0,0,0,0,0,128,255,0,0,0]];dist.bfx.w=256;dist.bfx.h=240;dist.buffer=document.createElement("canvas");dist.buffer.width=dist.bfx.w;dist.buffer.height=dist.bfx.h;dist.bufferwidth=dist.buffer.width;dist.bufferheight=dist.buffer.height;dist.bctx=dist.buffer.getContext("2d");dist.bgimage=document.getElementById(backgroundImage);dist.bctx.drawImage(dist.bgimage,0,0,416,416,0,0,dist.bfx.w,dist.bfx.h);dist.bufferData=dist.bctx.getImageData(0,0,dist.bfx.w,dist.bfx.h);dist.bdata=dist.bufferData.data;dist.bctx.mozImageSmoothingEnabled=false;dist.bctx.webkitImageSmoothingEnabled=false;dist.bctx.imageSmoothingEnabled=false;dist.visible=viewCanvas;dist.fctx=dist.visible.getContext("2d");dist.fctx.mozImageSmoothingEnabled=false;dist.fctx.webkitImageSmoothingEnabled=false;dist.fctx.imageSmoothingEnabled=false;dist.bfx.getType=function(){return dist.bfx.effect[2]};dist.bfx.getDuration=function(){return dist.bfx.effect[0]+(dist.bfx.effect[1]<<8)};dist.bfx.getFrequency=function(){return dist.bfx.effect[3]+(dist.bfx.effect[4]<<8)};dist.bfx.getAmplitude=function(){return dist.bfx.effect[5]+(dist.bfx.effect[6]<<8)};dist.bfx.getCompression=function(){return dist.bfx.effect[8]+(dist.bfx.effect[9]<<8)};dist.bfx.getFrequencyAcceleration=function(){return dist.bfx.effect[10]+(dist.bfx.effect[11]<<8)};dist.bfx.getAmplitudeAcceleration=function(){return dist.bfx.effect[12]+(dist.bfx.effect[13]<<8)};dist.bfx.getSpeed=function(){return dist.bfx.effect[14]};dist.bfx.getCompressionAcceleration=function(){return dist.bfx.effect[15]+(dist.bfx.effect[16]<<8)};dist.Distorter=function(y,t,distortEffect,ampl,ampl_accel,s_freq,s_freq_accel,compr,compr_accel,speed){var C1=(1/512).toFixed(6);var C2=(8*Math.PI/(1024*256)).toFixed(6);var C3=(Math.PI/60).toFixed(6);var amplitude=ampl+ampl_accel*t*2;var frequency=s_freq+s_freq_accel*t*2;var compression=compr+compr_accel*t*2;var S=Math.round(C1*amplitude*Math.sin((C2*frequency*y+C3*speed*t).toFixed(6)));if(distortEffect==1){return S}else if(distortEffect==2){return y%2==0?-S:S}else if(distortEffect==3){var L=Math.floor(y*(1+compression/256)+S)%256;if(L<0)L=256+L;if(L>255)L=256-L;return L}return 0};dist.ComputeFrame=function(dst,src,distortEffect,letterbox,ticks,alpha,erase,ampl,ampl_accel,s_freq,s_freq_accel,compr,compr_accel,speed){var bdst=dst;var bsrc=src;var dstStride=1024;var srcStride=1024;var x=0,y=0;for(y=0;y<224;y++){S=dist.Distorter(y,ticks,distortEffect,ampl,ampl_accel,s_freq,s_freq_accel,compr,compr_accel,speed);L=y;if(distortEffect==3){L=S}for(x=0;x<256;x++){var bpos=x*4+y*dstStride;if(y<letterbox||y>224-letterbox){bdst[bpos+2]=0;bdst[bpos+1]=0;bdst[bpos+0]=0;continue}var dx=x;if(distortEffect==1||distortEffect==2){dx=(x+S)%256;if(dx<0)dx=256+dx;if(dx>255)dx=256-dx}var spos=dx*4+L*srcStride;if(erase==1){bdst[bpos+3]=255;bdst[bpos+2]=alpha*bsrc[spos+2];bdst[bpos+1]=alpha*bsrc[spos+1];bdst[bpos+0]=alpha*bsrc[spos+0]}else{bdst[bpos+3]=255;bdst[bpos+2]+=alpha*bsrc[spos+2];bdst[bpos+1]+=alpha*bsrc[spos+1];bdst[bpos+0]+=alpha*bsrc[spos+0]}}}return bdst};dist.test=function(effs){dist.tickssy+=1;var blankcanvas=document.createElement("canvas");blankcanvas.width=dist.bfx.w;blankcanvas.height=dist.bfx.h;var ctx=blankcanvas.getContext("2d");var imageData=ctx.getImageData(0,0,dist.bfx.w,dist.bfx.h);var data=imageData.data;dist.bfx.effect=dist.bfx.effectsrom[effs];dist.bfx.getDuration();dist.ComputeFrame(data,dist.bdata,dist.bfx.getType(),0,dist.tickssy,dist.alpha,0,dist.bfx.getAmplitude(),dist.bfx.getAmplitudeAcceleration(),dist.bfx.getFrequency(),dist.bfx.getFrequencyAcceleration(),dist.bfx.getCompression(),dist.bfx.getCompressionAcceleration(),dist.bfx.getSpeed());ctx.putImageData(imageData,0,0);dist.fctx.drawImage(blankcanvas,0,0,dist.bfx.w,dist.bfx.h,screen.GSTARTX,screen.GSTARTY,screen.GWIDTH,screen.GHEIGHT+31)}};
</script>

<script>
battle={};battle.atk={};battle.skl={};battle.action={};battle.effect={};battle.setup=function(){battle.maxlevel=99;battle.herotoshowstatus=false;battle.order=new Array;battle.heroes=clone(resources.hms.Heroes);for(var hero in battle.heroes){battle.initHero(battle.heroes[hero])}};battle.initHero=function(hero){hero["side"]="hero";hero["xp"]=0;hero["level"]=0;hero["xpnextlevel"]=hero["ExpToLevel"][0]*hero["level"]+hero["ExpToLevel"][1];hero["skill"]=[];hero["hp"]=0;hero["hpmax"]=0;hero["mod"]={st:0,dx:0,iq:0};hero["equiped"]={weapon:false,armor:false};battle.uplevel(hero,1,true)};battle.initMonster=function(monster){monster["side"]="monster";monster["level"]=0;monster["skill"]=[];monster["hp"]=0;monster["hpmax"]=0;battle.setMonsterLevel(monster);if(!("prob"in monster)){var prob={};var totalprob=0;var atks=clone(monster["skill"]);atks.push("atk");for(var i=0;i<atks.length;i++){if(i==atks.length-1){prob[atks[i]]=1-totalprob}else{totalprob+=1/atks.length;prob[atks[i]]=1/atks.length}}monster["prob"]=prob}monster["xpreward"]=monster["ExpToLevel"][0]*monster["level"]+monster["ExpToLevel"][1];monster["dead"]=false};battle.uplevel=function(hero,leveltoup,silent){var silent=typeof silent==="undefined"?false:silent;var currlvl=hero["level"];if(leveltoup>currlvl){hero["st"]=Math.floor(leveltoup*hero["baseStats"]["st"]/battle.maxlevel);hero["dx"]=Math.floor(leveltoup*hero["baseStats"]["dx"]/battle.maxlevel);hero["iq"]=Math.floor(leveltoup*hero["baseStats"]["iq"]/battle.maxlevel);hero["hp"]=Math.floor(leveltoup*hero["baseStats"]["hp"]/battle.maxlevel);hero["hpmax"]=Math.floor(leveltoup*hero["baseStats"]["hp"]/battle.maxlevel);for(var i=currlvl+1;i<leveltoup+1;i++){var lvl=i.toString();var text=hero["name"]+" reached level "+lvl+"!";hero["level"]=i;hero["xpnextlevel"]+=hero["ExpToLevel"][0]*hero["level"]+hero["ExpToLevel"][1];if(lvl in hero["Pathway"]){if("learn"in hero["Pathway"][lvl]){var tolearn=hero["Pathway"][lvl]["learn"];for(var stuff in tolearn){hero[stuff].push(tolearn[stuff]);text+="\n"+hero["name"]+" learned "+tolearn[stuff]+"!"}}if("forget"in hero["Pathway"][lvl]){var toforget=hero["Pathway"][lvl]["forget"];for(var stuff in toforget){removeA(hero[stuff],toforget[stuff]);text+="\n"+hero["name"]+" forgot "+toforget[stuff]+"!"}}}if(!silent){actions.showText(text)}}}};battle.setMonsterLevel=function(mon){var mlevel=0;for(var i=0;i<player.party.length;i++){mlevel+=battle.hero[i].level}mlevel=Math.floor(mlevel/player.party.length);mlevel+=battle.diceroll(1)+player.party.length;mlevel=Math.max(mlevel-3,1);battle.uplevel(mon,mlevel,true)};battle.selectFromProb=function(probdict){var random=Math.random();var range=0;for(atsk in probdict){if(range<=random&&random<=range+probdict[atsk])return atsk;range+=probdict[atsk]}};battle.diceroll=function(n){var i=n;var result=0;while(i>0){i--;result+=Math.floor(Math.random()*3+1)}return result};battle.action.atk=function(){actions.showText("attack!")};battle.action.skill=function(skill){actions.showText(skill)};battle.start=function(monsterlist,musicBattle,musicHuzzah){battle.musicHuzzah=musicHuzzah;battle.musicBattle=musicBattle;battle.holdAtomStack=engine.atomStack;engine.atomStack=new Array;battle.monster=[];battle.hero=[];battle.waitherodecision=false;battle.bchToAttack=[];battle.ended=false;battle.xpreward=0;if(monsterlist.length>1){dist.efnumb[0]=31}for(var i=0;i<player.party.length;i++){battle.hero[i]=battle.heroes[player.party[i]]}for(var i=0;i<monsterlist.length;i++){battle.monster[i]=clone(resources.hms.Monsters[monsterlist[i]]);battle.initMonster(battle.monster[i])}battle.skills=resources.hms.Skills;battle.setOrderStack();bgmusic.play(battle.musicBattle);actions.fadeIn("blackFadeIn;doNotKeep")};battle.resolveOrder=function(){if(battle.ended){return}if(!battle.waitherodecision){if(battle.order.length>0){battle.bchToAttack=battle.order.shift();if(battle.bchToAttack[1]=="hero"){console.log("hero attack");if(battle.resolveIfSideDead()){return}battle.herodecision="action";actions.questionBox("attack;skill");battle.waitherodecision=true;if(battle.resolveIfSideDead()){return}}else{console.log("monster attack");if(battle.resolveIfSideDead()){return}if(!battle.bchToAttack[0].dead){battle.mAttack(battle.bchToAttack[0])}if(battle.resolveIfSideDead()){return}}}else{if(battle.isPartyAlive()){battle.setOrderStack()}}}else{battle.hAttack(battle.bchToAttack[0])}};battle.resolveIfSideDead=function(){if(!battle.isPartyAlive()){while(battle.order.length>0){battle.order.pop()}battle.ended=true;actions.showText("You died!");battle.end("died");return true}if(!battle.isMonstersAlive()){while(battle.order.length>0){battle.order.pop()}battle.ended=true;bgmusic.play(battle.musicHuzzah);actions.showText("You win!");battle.end("win");return true}return false};battle.setOrderStack=function(){while(battle.order.length>0){battle.order.pop()}for(var i=0;i<player.party.length;i++){battle.order.push([battle.hero[i],"hero"])}for(var i=0;i<battle.monster.length;i++){battle.order.push([battle.monster[i],"monster"])}battle.order.sort(function(a,b){if(a[0]["dx"]>b[0]["dx"])return-1;if(a[0]["dx"]<b[0]["dx"])return 1;return 0})};battle.hAct={};battle.hAct.askTarget=function(){engine.questionBoxAnswer=engine.questionBoxUndef;battle.hAct.targetting=true;battle.herodecision="target";var selmon=[];for(var i=0;i<battle.monster.length;i++){if(!battle.monster[i].dead){selmon.push(battle.monster[i])}}if(selmon.length==1){selmon[0].selected=false;battle.hAct.targetting=false;battle.hAct.__target=[selmon[0]];engine.questionBoxAnswer=0;HID.inputs["accept"].active=false;return}for(var i=0;i<selmon.length;i++){selmon[i].selected=false;selmon[i].flash=0;if(i==0){selmon[i].previous=selmon[0];selmon[i].next=selmon[i+1]}else if(i==selmon.length-1){selmon[i].previous=selmon[i-1];selmon[i].next=selmon[i]}else{selmon[i].previous=selmon[i-1];selmon[i].next=selmon[i+1]}}selmon[0].selected=true;battle.hAct.selectedMonster=selmon[0]};battle.hAct.changeSelection=function(next){battle.hAct.selectedMonster.selected=false;battle.hAct.selectedMonster=battle.hAct.selectedMonster[next];battle.hAct.selectedMonster.selected=true};battle.hAct.targetUpdate=function(){if(typeof this.keyPressed==="undefined"){this.keyPressed=0}if(this.keyPressed==0){if(HID.inputs["up"].active){battle.hAct.changeSelection("previous");HID.inputs["up"].active=false;this.keyPressed=32}else if(HID.inputs["left"].active){battle.hAct.changeSelection("previous");HID.inputs["left"].active=false;this.keyPressed=32}else if(HID.inputs["right"].active){battle.hAct.changeSelection("next");HID.inputs["right"].active=false;this.keyPressed=32}else if(HID.inputs["down"].active){battle.hAct.changeSelection("next");HID.inputs["down"].active=false;this.keyPressed=32}else if(HID.inputs["accept"].active){this.selectedMonster.selected=false;battle.hAct.targetting=false;battle.hAct.__target=[battle.hAct.selectedMonster];engine.questionBoxAnswer=0;HID.inputs["accept"].active=false;this.keyPressed=32}else if(HID.inputs["cancel"].active){}}else{this.keyPressed-=4}};battle.hAttack=function(hero){if(engine.questionBoxAnswer!=engine.questionBoxUndef&&battle.herodecision=="action"){if(engine.questionBoxAnswer==0){battle.hAct.__damage=battle.atk.pts(hero);battle.hAct.__actionType=["hpdown"];battle.hAct.__skill="atk";if(battle.monster.length<=1){battle.hAct.__target=[battle.monster[0]];var __proceed=true}else{battle.hAct.askTarget()}}else if(engine.questionBoxAnswer==1){battle.herodecision="skill";var options=hero["skill"].join(";");options="back;"+options;actions.questionBox(options)}}if(engine.questionBoxAnswer!=engine.questionBoxUndef&&battle.herodecision=="skill"){if(engine.questionBoxAnswer==0){battle.herodecision="action";actions.questionBox("attack;skill")}else{actions.showText(engine.questionBoxAnswerStr);battle.hAct.__damage=battle.skl.pts(hero,engine.questionBoxAnswerStr);battle.hAct.__actionType=battle.skills[engine.questionBoxAnswerStr].effect;battle.hAct.__target=[battle.monster[0]];battle.hAct.__skill=engine.questionBoxAnswerStr;var __proceed=true}}if(engine.questionBoxAnswer!=engine.questionBoxUndef&&battle.herodecision=="target"){var __proceed=true}if(typeof __proceed!=="undefined"){if(__proceed!=false){console.log("attacked");battle.resolveAtk(hero,battle.hAct.__target,battle.hAct.__damage,battle.hAct.__actionType,battle.hAct.__skill);actions.proceedBattleTurn()}}};battle.mAttack=function(mn){var mon=mn;var attack=battle.selectFromProb(mon["prob"]);var damage=0;var actionType=[];var target=[battle.mTarget(mon)];if(attack=="atk"){damage=battle.atk.pts(mon);actionType=["hpdown"]}else{damage=battle.skl.pts(mon,attack);actionType=battle.skills[attack].effect;if(battle.skills[attack].affect=="all")target=battle.hero}if(damage>0){screen.flashMonster(mon,"#eeeeee")}else{screen.shakeMonster(mon)}battle.resolveAtk(mon,target,damage,actionType,attack)};battle.resolveAtk=function(bchSrc,bchVct,dmg,act,skill){for(var j=0;j<bchVct.length;j++){for(var i=0;i<act.length;i++){battle.effect[act[i]](bchSrc,bchVct[j],dmg,skill)}}};battle.effect.hpdown=function(bchsrc,bch,dmg,skill){bch.hp=Math.max(bch["hp"]-dmg,0);if(skill=="atk"){actions.showText(bchsrc.name+" attacked "+bch.name+" and dealt "+dmg+" damage!")}else{actions.showText(bchsrc.name+" used "+skill+" on "+bch.name+" and dealt "+dmg+" damage!")}if(bch.side=="monster"){screen.flashMonster(bch,"#bf0010")}};battle.effect.hpup=function(bchsrc,bch,dmg){bch.hp=Math.min(bch["hp"]+dmg,bch["hpmax"])};battle.mTarget=function(monster){var dead=true;if(monster.target=="splash"){}else if(monster.target=="hero"){var options=battle.hero.length;for(var i=0;i<options;i++){if(battle.hero[i].Leader&&battle.isAlive(battle.hero[i])){return battle.hero[i]}}}else if(monster.target=="weakest"){var minhp=999999999;var index=0;for(var i=0;i<options;i++){if(battle.hero[i].hp<minhp&&battle.hero[i].hp>0){minhp=battle.hero[i]["hp"];index=i}}return battle.hero[index]}var target=0;var options=battle.hero.length;var targetProb={};for(var i=0;i<options;i++){targetProb[i]=1/options}var tries=0;while(dead){tries++;target=battle.selectFromProb(targetProb);dead=!battle.isAlive(battle.hero[target]);if(tries>20){break}}return battle.hero[target]};battle.end=function(battleresult){battle.lastresult=battleresult;for(var i=0;i<battle.hero.length;i++){if(battle.isAlive(battle.hero[i])){var thishero=battle.hero[i];thishero.xp+=Math.floor(battle.xpreward/battle.hero.length);while(thishero.xp>thishero.xpnextlevel){var newlevel=thishero.level+1;battle.uplevel(thishero,newlevel)}}}actions.changeState("map");engine.atomStack.push([function(){engine.atomStack=battle.holdAtomStack},""]);battle.holdAtomStack.push([function(){bgmusic.popSong()},""])};battle.isPartyAlive=function(){var test=0;for(var i=0;i<battle.hero.length;i++){test+=battle.isAlive(battle.hero[i])}return test>0};battle.monsterDies=function(monster){battle.xpreward+=monster.xpreward};battle.isMonstersAlive=function(){var test=0;for(var i=0;i<battle.monster.length;i++){test+=battle.isAlive(battle.monster[i]);if(!battle.isAlive(battle.monster[i])){if(!battle.monster[i].dead){battle.monster[i].dead=true;battle.monsterDies(battle.monster[i])}}}return test>0};battle.isAlive=function(bch){return bch["hp"]>0};battle.atk.pts=function(bch){return battle.diceroll(bch["st"])};battle.skl.pts=function(bch,skill){var baseplus=getkey0(battle.skills[skill],"basep");var plus=getkey0(battle.skills[skill],"plus");var attribut=0;if("atr"in battle.skills[skill])attribut=bch[battle.skills[skill]["atr"]];return Math.max(battle.diceroll(baseplus+attribut)+plus,0)};battle.mApplyState=function(mon,st){for(var k in mon.state[st]){mon[k]=mon.state[st][k]}};battle.update=function(){battle.resolveOrder();if(battle.hAct.targetting){battle.hAct.targetUpdate()}};
</script>

<script>
var bootstrap={};window.forceMobile=false;var query=window.location.search.substring(1).split("&");for(var i=0,max=query.length;i<max;i++){if(query[i]==="")continue;var param=query[i].split("=");if(param[0]=="forceMobile"&&(param[1]=="true"||param[1]=="True"||param[1]=="1"))window.forceMobile=true;if(param[0]=="debug"&&(param[1]=="true"||param[1]=="True"||param[1]=="1"))window.addEventListener("unload",function(e){e.preventDefault();jsonGet("http://127.0.0.1:8081/exit.json")},false)}bootstrap.onLoadDOM=function(){try{var child=document.getElementById("loading");child.parentNode.removeChild(child);document.ontouchmove=function(e){e.preventDefault()};document.getElementsByTagName("canvas")[0].getContext("2d").fillStyle="#FFFFFF";document.getElementsByTagName("canvas")[0].getContext("2d").fillText("LOADING...",64,64);resources.harvest(function(){png_font.setup(screen.ctx,"img/unifont.png",function(){screen.init();player.setup();engine.setup();screen.setEngine(engine);HID.setup(screen);engine.currentLevel=resources["levels"][resources.init["World"]["initLevel"]];screen.printBox.setup(resources.printerset);feedbackEng.setup();battle.setup();bgmusic.setup();title.setup();menus.setAllDrawables();chars=new charalist;chars.push(player);playbutton.setup(function(){debug.FPS.loop();engine.loop();screen.requestAnimationFrame.call(window,function(){screen.loop()});fullscreen.setup()})})})}catch(err){alert("Error on bootstrap! "+err)}};
</script>

<script>
bgmusic={setup:function(){this.songStack=[];this.playing=""},play:function(song,volume,currentTime){volume=typeof volume==="undefined"?.7:volume;currentTime=typeof currentTime==="undefined"?0:currentTime;if(!(song in resources.music))return;var playSong=function(that,song,volume,currentTime){return function(){that.playing=song;resources.music[song].volume=volume;resources.music[song].currentTime=currentTime;resources.music[song].play()}}(this,song,volume,currentTime);if(this.playing!=song){if(this.playing in resources.music){resources.music[this.playing].pause();setTimeout(playSong,150)}else{setTimeout(playSong,150)}}},pushSong:function(){var song=this.playing;this.songStack.push({song:song,volume:resources.music[song].volume,currentTime:resources.music[song].currentTime})},popSong:function(){var sp=this.songStack.pop();this.play(sp.song,sp.volume,sp.currentTime)}};
</script>

<script>
var fullscreen={waitTC:false,isFullscreen:false,exitFullscreen:function(){if(document.exitFullscreen){document.exitFullscreen()}else if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else if(document.webkitExitFullscreen){document.webkitExitFullscreen()}this.isFullscreen=false},launchIntoFullscreen:function(element){if(element.requestFullscreen){element.requestFullscreen()}else if(element.mozRequestFullScreen){element.mozRequestFullScreen()}else if(element.webkitRequestFullscreen){element.webkitRequestFullscreen()}else if(element.msRequestFullscreen){element.msRequestFullscreen()}this.isFullscreen=true;actions.alert("in fullscreen!")},setup:function(){var createButton=function(buttonname,context,func){var button=document.createElement("input");button.type="button";button.value=buttonname;button.id="fullscreen_button";button.style["appearance"]="none";button.style["box-shadow"]="none";button.style["border-radius"]=0;button.style["color"]="#bbb";button.style["background-color"]="#111";button.style["border"]="none";button.style["font-size"]="32px";button.style["font-family"]="INFO56";button.style.position="fixed";button.style["z-index"]=1e3;button.style.bottom="0px";button.style.left="0px";button.addEventListener("click",func);button.addEventListener("touchstart",func);context.appendChild(button)};createButton("[  ]",document.documentElement,function(){if(fullscreen.waitTC){return}else{fullscreen.waitTC=true;setTimeout(function(){fullscreen.waitTC=false},100)}if(fullscreen.isFullscreen){fullscreen.exitFullscreen();document.getElementById("fullscreen_button").value="[  ]";document.getElementById("fullscreen_button").style["color"]="#bbb"}else{fullscreen.launchIntoFullscreen(document.documentElement);document.getElementById("fullscreen_button").value=">[]<";document.getElementById("fullscreen_button").style["color"]="#666"}})}};
</script>

</head> 
	
<body onload="bootstrap.onLoadDOM()"> 
        
<div> 
		
<canvas id="viewport" width="416" height="704" style="image-rendering: pixelated"> 
</canvas> 
		
<font id="loading" color="white">  LOADING...
</font> 
        
</div> 
		
<img style="display:none" id="faceset" src="img/faceset.png"/> 
		
<img style="display:none" id="charasetimg" src="img/charaset.png"/> 
		
<img style="display:none" id="printerimg" src="img/printer.png" /> 
		
<img style="display:none" id="titleimg" src="img/title.png" /> 
		
<img style="display:none" id="monsterbattleimg" src="img/monsterset.png" /> 
		
<img style="display:none" id="bgimg1" src="img/bgimg1.png" /> 
		
<img style="display:none" id="keys1" src="img/sys/keysexplainer.png" /> 
		
<img style="display:none" id="keys2" src="img/sys/pckeys.png" /> 
		
<img style="display:none" id="controllers" src="img/sys/controllers.png" /> 

    
<audio id="audioStop" src="data:audio/wav;base64,UklGRoQJAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YWAJAACr/aL9jv10/VP9Lf0D
/dj8pPx2/D38BvzO+5D7VPsR+9T6ivpL+v35t/lr+Rv5z/h5+Cj40vd49yH3wfZm9gT2ofU99dX0
bfQC9JHzJ/Ov8kHyxvFR8dvwWvDh71zv2+5Y7s3tR+247C3snesJ63jq3ulK6a7oEeh159LmMuaO
5ebkQOSV4+jiPOKN4djgMuCL3/3eg94k3srdat3u3GTcwtsc22jasNnv2CfYXteO1s3VIdWl1E7U
I9T90/LT69Py0/7TEtQr1EjUatSR1KXUptRy1BfUmNP/0lbSo9Hj0B/QUs+HzsPNG82izF/MSMxJ
zGTMicy+zPnMPs2IzdvNLs6KzufOSc+/zzbQv9At0XnRk9F80UnRCNHK0KHQgtCB0IvQqNDJ0PfQ
N9GA0b7RDtJk0uLSZtME1JjUPtXf1YnWNtfs16zYe9lV2jjbKNwW3RLeDt8R4BfhI+Iw40PkWuVx
5pPnrujb6ffqLuxQ7Yfup+/Q8PrxIvNh9Jb13vYj+G35vfoO/Fb9mv65/7AAUQGyAckByAG0AcUB
FwKgAmADOAQnBTsGXAeaCNkJHAtWDI4NwA71DyMRWRKHE7sU7BUcF1IYgxm6Gu0bIx1YHpEfySAA
IjwjaiRSJfklSyZ2JmcmNCbiJW4l4yRKJKEj8SI3InohwyASIGYfvh4VHnMdyhw4HPEbFxyvHHUd
Zx5uH5IguyH4IjIkZCU8JrYmtSZhJtAlHSVGJFwjXCJRITogGx/yHcIckhtZGicZ/hfTFrsVjhRl
EzQS9BC3D20OJg3aC5kKVwkqCPEGwAWMBFgDJwLyAMH/jf5X/Sf86/q8+YD4SvcS9s30c/MJ8pHw
Fe+U7R3sxeq86fLoe+hc6HDovOgq6cTpfupN6yns3ewA7b3sKux/66nqw+nM6Mrnwuax5aLkkeN1
4mvhi+AJ4OzfN+C74GnhHuLP4kDjYOMT443i0eHn4Ozf497e3d3c3Nve2uLZ49jm1+3W79X41PzT
A9MH0vnQ988Cz2vOIs5LzqPOHs+7z2XQJNHv0bvSmNNw1FTVONYd1wrY9djj2dbaxdu/3LPdrt62
37bgqOFP4q/it+J84hDiduHJ4AXgPN9Y3oPdldyx29DaC9pp2fjYyNj42HrZONoj2zLcUN2K3sDf
E+Fa4rDjCOVf5rXnsehn6bHpxOmX6UPp1OhU6MLnLufH5sDmEeex52ToTulM6m3rnuzg7SnvffDT
8THzkfTw9Vf3tvgQ+k/7ivyz/eP+//8nATsCYgN2BJMFqwbGB9wI+AkOCyUMPg1UDmsPgxCVEbAS
vhPYFOUVABcLGCgZIRrzGnYbzBvpG9Ybmxs6G7MaGRpSGZMYthfZFvUVCBUZFCYTLhI4ETcQRw9T
Dn8NpgzZCw4LQgp4CbAI4gcdB3YGQAZbBskGVgcNCNIIrQmMCngLZgxWDTMO8A58D8wPzw+QDyEP
mg77DVQNmQzdCxwLRgpxCXwIfweBBnUFbQReA0wCPQEoABf/AP7t/Nf7xvrF+dr47vcP9x/2O/VJ
9FjzWfJU8UjwNu8o7g3tDOwc617qv+k+6djofOgv6N7nkOcU52/mo+XF5Nvj5eLp4evg5d/j3t/d
4tz42xLbOtpn2ZTY0NcB1z3WedWw1OXTB9Mj0jrRStBfz2nOf82JzKPLx8r1yTfJcsi+xwDHVcae
xfXERsSdw/LCT8KlwQPBY8C6vya/i74bvtO9y733vU++t749v8a/X8AEwavBYsIVw8rDc8TwxEDF
V8VPxSPF3sR5xP/DfsPuwl3Cy8ErwaHAB8CEv/y+cr7qvV291LxGvL+7NLurui26ublZuQ2527jZ
uAO5Urm9uTy61bp7uy6877yrvXm+Qb8bwPrA28HNwrHDlcR3xUvGE8fXx5LIX8kyyg/L7cvhzM/N
1s7Kz9nQ1NHi0tvT2NTI1b/Wrtey2KrZsdq427fcw92t3o3fRODS4DnheuGa4brhteHA4bDhq+Gd
4aHhuuEE4njiGePR45rkb+VM5ivnEejo6Mbpi+pc6x3s5Oyl7WLuJe/Z75rwTvEI8r/ycPMq9Nb0
jfU59u32nvdO+P74q/lK+vP6gvsk/K/8Q/3b/Wf+Av+R/ysAxgBbAfcBigImA7gDTwTjBHUFBgaa
BiEHuwdBCOAIcQkVCrAKUwv1C5UMNw3WDXcOFA+zD0wQ6BB3EQIShRIAE3wT8xNmFNoUTBW4FTMW
qRYsF6cXLhimGC0ZlBnyGRoaJRocGgQa+hnzGf0ZARoGGvwZ7xnjGdAZ0xnHGdYZ4hkGGi0aXxqI
GqoarxqjGnQaPRrsGZ8ZOBnVGGkY9ReMFxMXnhYsFq8VPxXBFEwU1RNoExETyhKsEpMSnBKgErsS
xRLlEvYSDxMtEzwTWhNmE3kTgRONE5ITlxOTE4UTZRM4E/ESpRJFEuoRgREeEboQZxAfEPkP3A/X
D9gP5g/3Dw4QJBBDEFkQeBCNEJwQqxCrEK0QqRCaEJkQjBCMEIIQbxBZEEAQHRD6D7sPhg9AD/0O
vA5vDi0O4g2dDVQNDQ3GDH8MOwzxC7ALZwsmC+AKnApaChcK1AmUCU8JDwnLCIMIPQjzB6sHYgcd
B84GjwZDBgcGygWGBVQFEAXhBLIEfgReBC4EGgT9A/MD4QPbA9ADxgO9A7EDowOQA30DYgNHAyED
9ALMApcCbAI4AgkC2QGnAXcBSgEXAe0AvACRAGMAOQAMAOX/tf+U/2T/Qv8W//X+zf6y/pX+ev5q
/kz+Pv4g/hD++P3q/d391v3Q/cv9xv3B/bz9rP2j/Y79gP1u/Vn9S/03/SX9FP0C/fL84vzP/MP8
sPyl/JP8h/x4/Gz8XfxU/EP8PPwt/CP8HPwJ/Ar89fv1++b74PvX+9D7xvvB+8L7xPvU+9v77vv+
+w78Jfwv/E38Uvxo/Gz8d/x8/Hn8fvx0/Hr8cvxz/G38bfxo/GX8Yvxg/F/8Yfxf/GT8Y/xp/Gj8
bPxq/Gv8afxo/Gr8bfxv/Hr8fPyP/Jf8o/y2/Lv81Pzb/PL8+/wR/Rf9Lf0x/T/9SP1M/Vj9WP1j
/WD9aP1p/Wz9cP11/Xn9hP2J/Zb9nv2r/bT9wP3M/db95P3s/fr9BP4P/hz+Jf4y/jr+Rv5M/lf+
Xv5e/mn+Yv5v/mr+cf5y/nX+d/56/nz+gP6D/oX+dP7J/wsA9v8KAPf/BwD5/wcA+f8=" preload="auto"> 
</audio> 

    
<audio id="audioWord" src="data:audio/wav;base64,UklGRtwAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YbgAAADPCcwKZArsC8QNEw4z
DroPhRE9EU0RzhOYFP8TMBX/Fl4XRhfdGLYaTBqeGvkcnx0xHTgeNSBzIAEgFSLKIxoj0SP+JX8m
AyY/Jzwp+CiaKMkq/CtYKxMsyS1rLhQuSC4mLiQuHi5gLGArpCvbKi4pcSgFKVonViXcJWQlliOQ
ItwiOCIgILcfMCCVHukcKB0JHUgbCBq+GjsamRdVFwYYTRZaFIUUjxRZEsIQfBF9EMwNqQ2/DfkL" preload="auto"> 
</audio> 

		
<p style="font-family:Helvetica;font-size:20px;" id="log"> log
</p> 

<!--
  // MIT LICENSE
	// Copyright (c) 2016 rico Vieira Porto
	//
	// Permission is hereby granted, free of charge, to any
	// person obtaining a copy of this software and associated
	// documentation files (the "Software"), to deal in the
	// Software without restriction, including without limitation
	// the rights to use, copy, modify, merge, publish, distribute,
	// sublicense, and/or sell copies of the Software, and to
	// permit persons to whom the Software is furnished to do so,
	// subject to the following conditions:
	//
	// The above copyright notice and this permission notice shall be
	// included in all copies or substantial portions of the Software.
	//
	// You can't claim ownership, use, copy, modify, merge, publish,
	// distribute, sublicense, and/or sell any software, images or
	// documents that includes characters, assets, or story elements
	// of the game distributed along with this engine.
	//
	// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
	// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
	// OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
	// NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
	// HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
	// WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
	// FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
	// OTHER DEALINGS IN THE SOFTWARE. --> 

	
</body> 

